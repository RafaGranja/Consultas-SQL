SELECT CONSUMO_PLANEJADO - CONSUMO_APONTADO CONSUMO_SALDO, CONSUMO_PLANEJADO - SALDO_REQ SALDO_REQUISITADO, * 
FROM  	(SELECT 		P.IDPRD, P.CODIGOPRD, P.DESCRICAO, C.QUANTIDADE CONSUMO_PLANEJADO, P.CODUNDCONTROLE, A.CODORDEM, A.IDATVORDEM, A.CODATIVIDADE, A.CODCOLIGADA, A.CODFILIAL, KA.DSCATIVIDADE, KE.CODCCUSTO,  
								NULL IDPRDORIGEM,  P.IDPRD PRINCIPAL, 1 SEQ, 		
							ISNULL((SELECT  			SUM(QUANTIDADE) 			FROM 			KATVORDEMMP 			
						WHERE 			
						IDPRODUTO = C.IDPRODUTO AND CODCOLIGADA = A.CODCOLIGADA AND CODFILIAL = A.CODFILIAL AND CODESTRUTURA = A.CODESTRUTURA AND CODORDEM = A.CODORDEM AND IDATIVIDADE = A.IDATVORDEM AND EFETIVADO = 1 		),0) 
						CONSUMO_APONTADO,
 						ISNULL((SELECT SUM(QUANTIDADE) 					
								FROM 					
								(SELECT 						 
									IM.QUANTIDADE 					
									FROM KCOMPONENTE KC 						
									INNER JOIN TMOV M ON KC.CODCOLIGADA = M.CODCOLIGADA AND KC.CODFILIAL = M.CODFILIAL 						
									INNER JOIN TITMMOV IM ON M.CODCOLIGADA = IM.CODCOLIGADA AND M.CODFILIAL = IM.CODFILIAL AND M.IDMOV = IM.IDMOV AND KC.IDPRODUTO = IM.IDPRD 					
									WHERE M.CODTMV='1.1.05' AND M.CAMPOLIVRE1=A.CODORDEM AND M.CAMPOLIVRE2=A.IDATVORDEM AND KC.IDPRODUTO = P.IDPRD 	AND KC.CODESTRUTURA=A.CODESTRUTURA AND M.STATUS <>'C'  				
									UNION ALL  					
									SELECT 	IM.QUANTIDADE 				
									FROM  KCOMPONENTE KC
									INNER JOIN KCOMPSUBSTITUTO KSS ON KC.CODCOLIGADA = KSS.CODCOLIGADA AND KC.CODFILIAL = KSS.CODFILIAL AND KC.CODESTRUTURA = KSS.CODESTRUTURA AND KC.IDPRODUTO = KSS.IDPRDORIGEM 						
									INNER JOIN TMOV M ON KC.CODCOLIGADA = M.CODCOLIGADA AND KC.CODFILIAL = M.CODFILIAL 						
									INNER JOIN TITMMOV IM ON M.CODCOLIGADA = IM.CODCOLIGADA AND M.CODFILIAL = IM.CODFILIAL AND M.IDMOV = IM.IDMOV AND IM.IDPRD = KSS.IDPRD 					WHERE  						M.CODTMV='1.1.05' 						AND M.CAMPOLIVRE1=A.CODORDEM AND M.CAMPOLIVRE2=A.IDATVORDEM AND KC.IDPRODUTO = P.IDPRD 						AND KC.CODESTRUTURA=A.CODESTRUTURA 						AND M.STATUS <>'C') Z),0) SALDO_REQ,  		E.SALDOFISICO2 ESTOQUE_ATUAL, E.SALDOFISICO3 ESTOQUE_ALOCADO, E.SALDOFISICO2 - E.SALDOFISICO3 ESTOQUE_SALDO, E.CUSTOMEDIO, E.CODLOC 	FROM 		KATVORDEM A  		INNER JOIN KATVORDEMMP C ON C.CODCOLIGADA = A.CODCOLIGADA AND C.CODFILIAL = A.CODFILIAL AND C.CODORDEM = A.CODORDEM AND C.IDATIVIDADE = A.IDATVORDEM AND C.EFETIVADO=0 		INNER JOIN TPRD P ON C.CODCOLIGADA = P.CODCOLIGADA AND C.IDPRODUTO = P.IDPRD 		INNER JOIN KITEMORDEM KO ON A.CODCOLIGADA = KO.CODCOLIGADA AND A.CODFILIAL = KO.CODFILIAL AND A.CODESTRUTURA = KO.CODESTRUTURA AND A.CODORDEM = KO.CODORDEM 		INNER JOIN KATIVIDADE KA ON A.CODCOLIGADA = KA.CODCOLIGADA AND A.CODFILIAL = KA.CODFILIAL AND A.CODATIVIDADE = KA.CODATIVIDADE 		INNER JOIN KESTRUTURA KE ON A.CODCOLIGADA = KE.CODCOLIGADA AND A.CODFILIAL = KE.CODFILIAL AND A.CODESTRUTURA = KE.CODESTRUTURA 		LEFT JOIN TPRDLOC E ON E.CODCOLIGADA = P.CODCOLIGADA AND E.CODFILIAL = C.CODFILIAL AND E.IDPRD = P.IDPRD AND E.CODLOC IN ('20','21','22')  	WHERE 		A.CODCOLIGADA = 1 		AND   A.CODFILIAL = 7 		 AND  A.CODORDEM IN ('29065/22','29066/22')   		AND	  (P.CODIGOPRD NOT LIKE '01.053.%' AND P.CODIGOPRD NOT LIKE '03.%' AND P.CODIGOPRD NOT LIKE '04.%' AND P.CODIGOPRD NOT LIKE '01.019.%' AND P.CODIGOPRD NOT LIKE '01.020.%') 		AND  A.IDATVORDEM <> ISNULL((SELECT IDATVORDEM FROM ZMDPLANOAPROVEITAMENTOCORTE WHERE CODCOLIGADA = A.CODCOLIGADA AND CODFILIAL = A.CODFILIAL AND CODORDEM = A.CODORDEM AND IDATVORDEM = A.IDATVORDEM),0)   	UNION ALL  	SELECT 		P.IDPRD, P.CODIGOPRD, CONCAT('(SUBSTITUTO)',' - ',P.DESCRICAO) DESCRICAO, C.QUANTIDADE CONSUMO_PLANEJADO, P.CODUNDCONTROLE, A.CODORDEM, A.IDATVORDEM, A.CODATIVIDADE, A.CODCOLIGADA, A.CODFILIAL, KA.DSCATIVIDADE, KE.CODCCUSTO, KS.IDPRDORIGEM, KS.IDPRDORIGEM PRINCIPAL, 2 SEQ,  		ISNULL((SELECT  			SUM(QUANTIDADE) 			FROM 			KATVORDEMMP 			WHERE 			IDPRODUTO = C.IDPRODUTO AND CODCOLIGADA = A.CODCOLIGADA AND CODFILIAL = A.CODFILIAL AND CODESTRUTURA = A.CODESTRUTURA AND CODORDEM = A.CODORDEM AND IDATIVIDADE = A.IDATVORDEM AND EFETIVADO = 1 		),0) CONSUMO_APONTADO, 		ISNULL((SELECT SUM(QUANTIDADE) 					FROM 					(SELECT 						 IM.QUANTIDADE 					FROM 						KCOMPONENTE KC 						INNER JOIN TMOV M ON KC.CODCOLIGADA = M.CODCOLIGADA AND KC.CODFILIAL = M.CODFILIAL 						INNER JOIN TITMMOV IM ON M.CODCOLIGADA = IM.CODCOLIGADA AND M.CODFILIAL = IM.CODFILIAL AND M.IDMOV = IM.IDMOV AND IM.IDPRD = KC.IDPRODUTO 					WHERE 						M.CODTMV='1.1.05' 						AND M.CAMPOLIVRE1=A.CODORDEM AND M.CAMPOLIVRE2=A.IDATVORDEM AND KC.IDPRODUTO = KS.IDPRDORIGEM 						AND KC.CODESTRUTURA=A.CODESTRUTURA 						AND M.STATUS <>'C'  					UNION ALL  					SELECT 						 IM.QUANTIDADE 					FROM 						KCOMPONENTE KC 						INNER JOIN KCOMPSUBSTITUTO KSS ON KC.CODCOLIGADA = KSS.CODCOLIGADA AND KC.CODFILIAL = KSS.CODFILIAL AND KC.CODESTRUTURA = KSS.CODESTRUTURA AND KC.IDPRODUTO = KSS.IDPRDORIGEM 						INNER JOIN TMOV M ON KC.CODCOLIGADA = M.CODCOLIGADA AND KC.CODFILIAL = M.CODFILIAL 						INNER JOIN TITMMOV IM ON M.CODCOLIGADA = IM.CODCOLIGADA AND M.CODFILIAL = IM.CODFILIAL AND M.IDMOV = IM.IDMOV AND IM.IDPRD = KSS.IDPRD 					WHERE 						M.CODTMV='1.1.05' 						AND M.CAMPOLIVRE1=A.CODORDEM AND M.CAMPOLIVRE2=A.IDATVORDEM AND KC.IDPRODUTO = KS.IDPRDORIGEM 						AND KC.CODESTRUTURA=A.CODESTRUTURA 						AND M.STATUS <>'C') Z),0) SALDO_REQ, 		E.SALDOFISICO2 ESTOQUE_ATUAL, E.SALDOFISICO3 ESTOQUE_ALOCADO, E.SALDOFISICO2 - E.SALDOFISICO3 ESTOQUE_SALDO, E.CUSTOMEDIO, E.CODLOC 	FROM 		KATVORDEM A  		INNER JOIN KATVORDEMMP C ON C.CODCOLIGADA = A.CODCOLIGADA AND C.CODFILIAL = A.CODFILIAL AND C.CODORDEM = A.CODORDEM AND C.IDATIVIDADE = A.IDATVORDEM AND C.EFETIVADO=0 		INNER JOIN KCOMPSUBSTITUTO KS ON KS.CODCOLIGADA = A.CODCOLIGADA AND KS.CODFILIAL = A.CODFILIAL AND KS.CODESTRUTURA = A.CODESTRUTURA AND C.IDPRODUTO = KS.IDPRDORIGEM 		INNER JOIN TPRD P ON C.CODCOLIGADA = P.CODCOLIGADA AND KS.IDPRD = P.IDPRD 		INNER JOIN KITEMORDEM KO ON A.CODCOLIGADA = KO.CODCOLIGADA AND A.CODFILIAL = KO.CODFILIAL AND A.CODESTRUTURA = KO.CODESTRUTURA AND A.CODORDEM = KO.CODORDEM 		INNER JOIN KATIVIDADE KA ON A.CODCOLIGADA = KA.CODCOLIGADA AND A.CODFILIAL = KA.CODFILIAL AND A.CODATIVIDADE = KA.CODATIVIDADE 		INNER JOIN KESTRUTURA KE ON A.CODCOLIGADA = KE.CODCOLIGADA AND A.CODFILIAL = KE.CODFILIAL AND A.CODESTRUTURA = KE.CODESTRUTURA 		LEFT JOIN TPRDLOC E ON E.CODCOLIGADA = P.CODCOLIGADA AND E.CODFILIAL = C.CODFILIAL AND E.IDPRD = P.IDPRD AND E.CODLOC IN ('20','21','22')  	WHERE 		A.CODCOLIGADA = 1 		AND   A.CODFILIAL = 7 		 AND  A.CODORDEM IN ('29065/22','29066/22')   		AND	  (P.CODIGOPRD NOT LIKE '01.053.%' AND P.CODIGOPRD NOT LIKE '03.%' AND P.CODIGOPRD NOT LIKE '04.%' AND P.CODIGOPRD NOT LIKE '01.019.%') 		AND  A.IDATVORDEM <> ISNULL((SELECT IDATVORDEM FROM ZMDPLANOAPROVEITAMENTOCORTE WHERE CODCOLIGADA = A.CODCOLIGADA AND CODFILIAL = A.CODFILIAL AND CODORDEM = A.CODORDEM AND IDATVORDEM = A.IDATVORDEM),0)    	) Z ORDER BY 	CODORDEM, PRINCIPAL, SEQ 
