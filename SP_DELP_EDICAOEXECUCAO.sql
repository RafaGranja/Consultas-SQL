USE [CORPORE]
GO
/****** Object:  StoredProcedure [dbo].[SP_DELP_EDICAOEXECUCAO]    Script Date: 16/10/2024 09:26:10 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



ALTER PROCEDURE [dbo].[SP_DELP_EDICAOEXECUCAO] @NUMPROCESSO INT,@NUM_OS VARCHAR(30), @CODTRFPAI VARCHAR(10), @EXECUCAO INT, @IDCRIACAO INT=NULL
AS
BEGIN

	SET NOCOUNT ON;

	SET LOCK_TIMEOUT 300000;  

	DECLARE @CODCOLIGADA INT, @CODFILIAL INT;
	
	/**************************************************************************************************************************************************************
		
		ESSA PROCEDURE É EXECUTADA PELO FLUIG VIA DRIVER JDBC DE CONEXÃO, POR ESSE MOTIVO CADA STATEMENTE ( UPDATE,INSERT,DELETE ) DEVE SER INICIADO COM 'BEGIN TRAN'
		E FINALIZADO COM UM COMMIT, CASO CONTRÁRIO É POSSÍVEL QUE A PROCEDURE ENTRE EM LOCK DENTRO DELA MESMA
		TAMBEM EVITE REALIZAR COMANDOS EXEC POIS PODEM CAUSAR LOCKS TAMBÉM

	***************************************************************************************************************************************************************/

	IF @NUMPROCESSO!=0
	BEGIN 

		SELECT @CODCOLIGADA=CODCOLIGADA,@CODFILIAL=CODFILIAL,@NUM_OS=NUM_OS,
		@CODTRFPAI=CASE WHEN CODTRFEX='' THEN NULL ELSE CODTRFEX END,@EXECUCAO=CASE WHEN EXECUCAO_INFO='' THEN NULL ELSE EXECUCAO_INFO END
		FROM FLUIG.DBO.ML001007 (NOLOCK) WHERE NUMPROCESSO=@NUMPROCESSO

	END
	ELSE
	BEGIN
		SELECT @CODCOLIGADA=CODCOLIGADA,@CODFILIAL=CODFILIAL
		FROM MPRJ (NOLOCK) WHERE CODPRJ=@NUM_OS AND POSICAO IN (1,4)
	END
	-- INICIO DAS ALTERAÇÕES
	IF @NUM_OS IS NULL OR @NUM_OS='' OR @CODTRFPAI IS NULL OR @CODTRFPAI='' OR @EXECUCAO IS NULL OR @EXECUCAO=''
	BEGIN
		IF @NUMPROCESSO IS NULL OR @NUMPROCESSO=''
			BEGIN
				RAISERROR('SOLICITAÇÃO INVÁLIDO',16,1)
			END
		ELSE
			BEGIN
				RAISERROR('PROJETO INVÁLIDO',16,1)
			END
	END;

	/**************************************************************************************************************************************************************
		
		BUSCA PELAS INFORMAÇÕES DA SOLICITAÇÃO DE INTEGRAÇÃO DO FLUIG

	***************************************************************************************************************************************************************/
	
	/**************************************************************************************************************************************************************
		
		CASO O NÚMERO DA OS OU O NÚMERO DA SOLICITAÇÃO ESTEJA VAZIO/NULO, UM ERRO SERÁ LANÇADO E A PROCEDURE SERÁ ENCERRADA

	***************************************************************************************************************************************************************/
	
	/**************************************************************************************************************************************************************
		
		ÍNICIO DAS TRATATIVAS DOS ITENS QUE FORAM EXCLUÍDOS DA ESTRUTURA, ESTES ITENS POSSUEM O CAMPO 'ITEMEXCLUSIVO' IGUAL A 2

	***************************************************************************************************************************************************************/

	BEGIN TRAN 
	
		UPDATE P SET INATIVO = 1, RECMODIFIEDON=GETDATE()
		FROM TPRODUTO  P 
			INNER JOIN FLUIG.DBO.Z_CRM_EX001005(NOLOCK) I ON I.IDPRD = P.IDPRD AND I.CODCOLIGADA = P.CODCOLPRD
			LEFT JOIN FLUIG.dbo.Z_CRM_ML001005 (NOLOCK) I2 ON I.OS = I2.OS AND I.IDCRIACAO = I2.IDCRIACAO
		WHERE I.OS = @NUM_OS AND I.EXECUCAO=@EXECUCAO AND I.CODTRFPAI=@CODTRFPAI AND I.ITEMEXCLUSIVO=2 AND I2.IDCRIACAO IS NULL AND NOT EXISTS( SELECT IDPRD FROM FLUIG.DBO.Z_CRM_EX001005 WHERE IDPRD=P.IDPRD UNION SELECT IDPRD FROM FLUIG.DBO.Z_CRM_ML001005 WHERE IDPRD=P.IDPRD)
		AND I.IDCRIACAO=ISNULL(@IDCRIACAO,I.IDCRIACAO) ;
			
	COMMIT

	/**************************************************************************************************************************************************************
		
		DESATIVA OS PRODUTOS CASO AQUELE ITEM TENHA SIDO EXCLUÍDO E NÃO TENHA MAIS NENHUM ITEM COM ESSE PRODUTO EM OUTRAS ESTRUTURAS OU COM OP CRIADA

	***************************************************************************************************************************************************************/

	BEGIN TRAN 

		UPDATE P SET STATUSESTR = 0, RECMODIFIEDON=GETDATE()
		FROM KESTRUTURA  P 
			INNER JOIN FLUIG.DBO.Z_CRM_EX001005(NOLOCK) I ON I.IDPRD = P.IDPRODUTO AND I.CODCOLIGADA = P.CODCOLIGADA
			LEFT JOIN FLUIG.dbo.Z_CRM_ML001005 (NOLOCK) I2 ON I.OS = I2.OS AND I.IDCRIACAO = I2.IDCRIACAO
		WHERE I.OS = @NUM_OS AND I.EXECUCAO=@EXECUCAO AND I.CODTRFPAI=@CODTRFPAI AND I.ITEMEXCLUSIVO=2 AND I2.IDCRIACAO IS NULL AND NOT EXISTS( SELECT IDPRD FROM FLUIG.DBO.Z_CRM_EX001005 WHERE IDPRD=P.IDPRODUTO UNION SELECT IDPRD FROM FLUIG.DBO.Z_CRM_ML001005 WHERE IDPRD=P.IDPRODUTO)
		AND I.IDCRIACAO=ISNULL(@IDCRIACAO,I.IDCRIACAO) ;
			
	COMMIT

	/**************************************************************************************************************************************************************
		
		DESATIVA AS ESTRUTURAS CASO AQUELE ITEM TENHA SIDO EXCLUÍDO E NÃO TENHA MAIS NENHUM ITEM COM ESSE PRODUTO EM OUTRAS ESTRUTURAS OU COM OP CRIADA

	***************************************************************************************************************************************************************/	

	BEGIN TRAN 

		DELETE  A FROM FLUIG.DBO.Z_CRM_EX001021 A 
		INNER JOIN FLUIG.DBO.Z_CRM_EX001021 B ON
		A.OSPROCESSO=B.OSPROCESSO
		AND A.EXECUCAO=B.EXECUCAO
		AND A.IDCRIACAOPROCESSO=B.IDCRIACAOPROCESSO
		AND A.CODATIVIDADE=B.CODATIVIDADE
		AND A.ID!=B.ID
		WHERE A.ID<B.ID AND A.OSPROCESSO=@NUM_OS AND A.EXECUCAO = @EXECUCAO AND A.IDCRIACAOPROCESSO=ISNULL(@IDCRIACAO,A.IDCRIACAOPROCESSO) 

	COMMIT
	
	/**************************************************************************************************************************************************************
		
		DELETA ATIVIDADES REPETIDAS DA EXECUÇÃO

	***************************************************************************************************************************************************************/

	BEGIN TRAN

		UPDATE C SET SUBSTITUTOCOMPONENTES=''
		FROM  FLUIG.dbo.Z_CRM_EX001005 (NOLOCK) I 
			INNER JOIN FLUIG.dbo.Z_CRM_EX001019 (NOLOCK) C ON I.OS = C.OSCOMPONENTES AND C.IDCRIACAOCOMPONENTES = I.IDCRIACAO AND C.EXECUCAO = I.EXECUCAO
		WHERE  @NUM_OS = I.OS AND C.SUBSTITUTOCOMPONENTES='null' AND I.CODTRFPAI=@CODTRFPAI AND I.EXECUCAO=@EXECUCAO AND I.IDCRIACAO=ISNULL(@IDCRIACAO,I.IDCRIACAO) 
			

	COMMIT

	/**************************************************************************************************************************************************************
		
		CORRIGE COMPONENTES DA ESTRUTURA DE EXECUÇÃO

	***************************************************************************************************************************************************************/

	
	BEGIN TRAN

		UPDATE Z SET CODIGOPRD=NULL,IDPRD=NULL,PRODUTORM=NULL
		FROM FLUIG.DBO.Z_CRM_EX001005 Z WHERE TIPODESENHO IN('NAOMANUFATURADO','INDUSTRIALIZACAO')
		AND ISNULL(CODIGOPRD,'')!=''  AND OS=@NUM_OS AND CODTRFPAI=@CODTRFPAI AND EXECUCAO=@EXECUCAO AND IDCRIACAO=ISNULL(@IDCRIACAO,IDCRIACAO) 

	COMMIT
	
	/**************************************************************************************************************************************************************
		
		CORRIGE CODIGOPRD DOS NÃO MANUFATURADOS E INDUSTRIALIZADOS

	***************************************************************************************************************************************************************/

	IF @IDCRIACAO IS NULL
	BEGIN

		BEGIN TRAN 
	-- INICIA COM AS EXCLUSÕES DAS EDIÇÕES

			--CANCELA ORDENS DE PRODUÇÃO QUE FORAM EXCLUÍDAS DA ESTRUTURA PARTE 1
			UPDATE O SET STATUS = 6, RECMODIFIEDON=GETDATE()
			FROM FLUIG.DBO.Z_CRM_EX001005(NOLOCK) I
				INNER JOIN KITEMORDEM O ON I.CODCOLIGADA = O.CODCOLIGADA AND I.CODFILIAL = O.CODFILIAL AND O.CODESTRUTURA = I.CODIGOPRD COLLATE SQL_Latin1_General_CP1_CI_AI AND O.CODCCUSTO = I.OS COLLATE SQL_Latin1_General_CP1_CI_AI 
				INNER JOIN KORDEMCOMPL(NOLOCK) C ON C.CODCOLIGADA = O.CODCOLIGADA AND C.CODFILIAL = O.CODFILIAL AND C.CODORDEM = O.CODORDEM AND I.EXECUCAO = C.NUMEXEC
				INNER JOIN KORDEM KO ON KO.CODCOLIGADA=O.CODCOLIGADA AND KO.CODFILIAL=O.CODFILIAL AND KO.CODORDEM=O.CODORDEM
				LEFT JOIN FLUIG.DBO.Z_DELP_NECESSIDADEPAPC(NOLOCK) P ON P.CODCOLIGADA=O.CODCOLIGADA AND P.CODFILIAL=O.CODFILIAL AND P.CODORDEM=O.CODORDEM
			WHERE I.OS = @NUM_OS AND I.EXECUCAO = @EXECUCAO AND I.CODTRFEX=@CODTRFPAI AND I.ITEMEXCLUSIVO=2 AND ISNULL(KO.REPROCESSAMENTO,0)!=1 AND O.STATUS=0 AND P.NSEQPEDIDO IS NULL AND I.TIPODESENHO NOT IN ('NAOMANUFATURADO','INDUSTRIALIZACAO')
			AND I.IDCRIACAO=ISNULL(@IDCRIACAO,I.IDCRIACAO) ; 

		COMMIT

		/**************************************************************************************************************************************************************
		
			CANCELA ITEM DA ORDEM DE PRODUÇÃO QUE FOI EXCLUÍDA DA ESTRUTURA DE EXECUÇÃO

		***************************************************************************************************************************************************************/

		BEGIN TRAN 
		--CANCELA ORDENS DE PRODUÇÃO QUE FORAM EXCLUÍDAS DA ESTRUTURA PARTE 2
			UPDATE K SET STATUS = 6, RECMODIFIEDON=GETDATE()
			FROM FLUIG.DBO.Z_CRM_EX001005(NOLOCK) I
				INNER JOIN KITEMORDEM(NOLOCK) O ON I.CODCOLIGADA = O.CODCOLIGADA AND I.CODFILIAL = O.CODFILIAL AND O.CODESTRUTURA = I.CODIGOPRD COLLATE SQL_Latin1_General_CP1_CI_AI AND O.CODCCUSTO = I.OS COLLATE SQL_Latin1_General_CP1_CI_AI 
				INNER JOIN KORDEMCOMPL(NOLOCK) C ON C.CODCOLIGADA = O.CODCOLIGADA AND C.CODFILIAL = O.CODFILIAL AND C.CODORDEM = O.CODORDEM AND I.EXECUCAO = C.NUMEXEC
				INNER JOIN KORDEM K ON K.CODCOLIGADA = O.CODCOLIGADA AND K.CODFILIAL = O.CODFILIAL AND K.CODORDEM = O.CODORDEM
				LEFT JOIN FLUIG.DBO.Z_DELP_NECESSIDADEPAPC(NOLOCK) P ON P.CODCOLIGADA=O.CODCOLIGADA AND P.CODFILIAL=O.CODFILIAL AND P.CODORDEM=O.CODORDEM
			WHERE I.OS = @NUM_OS AND I.EXECUCAO = @EXECUCAO  AND I.CODTRFEX=@CODTRFPAI AND I.ITEMEXCLUSIVO=2 AND ISNULL(K.REPROCESSAMENTO,0)!=1 AND O.STATUS=6 AND P.NSEQPEDIDO IS NULL AND I.TIPODESENHO NOT IN ('NAOMANUFATURADO','INDUSTRIALIZACAO')
			AND I.IDCRIACAO=ISNULL(@IDCRIACAO,I.IDCRIACAO) ; 


		COMMIT

		/**************************************************************************************************************************************************************
		
				CANCELA A ORDEM DE PRODUÇÃO QUE FOI EXCLUÍDA DA ESTRUTURA DE EXECUÇÃO

		***************************************************************************************************************************************************************/

		BEGIN TRAN 
		--CANCELA ATIVIDADES DAS ORDENS DE PRODUÇÃO QUE FORAM EXCLUÍDAS DA ESTRUTURA E NÃO POSSUEM APONTAMENTO
			UPDATE K SET STATUS = 6, RECMODIFIEDON=GETDATE()
			FROM FLUIG.DBO.Z_CRM_EX001005 ( NOLOCK ) I 
				INNER JOIN KITEMORDEM(NOLOCK) O ON I.CODCOLIGADA = O.CODCOLIGADA AND I.CODFILIAL = O.CODFILIAL AND O.CODESTRUTURA = I.CODIGOPRD COLLATE SQL_Latin1_General_CP1_CI_AI AND O.CODCCUSTO = I.OS COLLATE SQL_Latin1_General_CP1_CI_AI 
				INNER JOIN KORDEMCOMPL(NOLOCK) C ON C.CODCOLIGADA = O.CODCOLIGADA AND C.CODFILIAL = O.CODFILIAL AND C.CODORDEM = O.CODORDEM AND I.EXECUCAO = C.NUMEXEC
				INNER JOIN KORDEM KO ON KO.CODCOLIGADA=O.CODCOLIGADA AND KO.CODFILIAL=O.CODFILIAL AND KO.CODORDEM=O.CODORDEM
				INNER JOIN KATVORDEM K ON K.CODCOLIGADA = O.CODCOLIGADA AND K.CODFILIAL = O.CODFILIAL AND K.CODORDEM = O.CODORDEM
				LEFT JOIN FLUIG.DBO.Z_DELP_NECESSIDADEPAPC(NOLOCK) P ON P.CODCOLIGADA=O.CODCOLIGADA AND P.CODFILIAL=O.CODFILIAL AND P.CODORDEM=O.CODORDEM AND P.CODATIVIDADE=K.CODATIVIDADE
				LEFT JOIN FLUIG.dbo.Z_CRM_EX001021 (NOLOCK) I21 ON I.OS = I21.OSPROCESSO AND I21.IDCRIACAOPROCESSO = I.IDCRIACAO  AND I21.EXECUCAO = I.EXECUCAO AND I21.CODATIVIDADE=K.CODATIVIDADE COLLATE SQL_Latin1_General_CP1_CI_AI 
			WHERE I.OS = @NUM_OS AND I.EXECUCAO = @EXECUCAO  AND I.CODTRFEX=@CODTRFPAI AND ISNULL(KO.REPROCESSAMENTO,0)!=1 AND ( O.STATUS=6 OR (I21.CODATIVIDADE IS NULL AND K.STATUS=0) ) AND P.NSEQPEDIDO IS NULL AND I.TIPODESENHO NOT IN ('NAOMANUFATURADO','INDUSTRIALIZACAO')
			AND I.IDCRIACAO=ISNULL(@IDCRIACAO,I.IDCRIACAO) ; 
		
		COMMIT
		
		/**************************************************************************************************************************************************************
		
			CANCELA AS ATIVIDADES DA ORDEM DE PRODUÇÃO QUE FOI EXCLUÍDA DA ESTRUTURA DE EXECUÇÃO

		***************************************************************************************************************************************************************/

		BEGIN TRAN 
	
			UPDATE K SET STATUS=6
			FROM 
			KITEMORDEM K INNER JOIN KORDEM KO 
			ON K.CODCOLIGADA=KO.CODCOLIGADA 
			AND K.CODFILIAL=KO.CODFILIAL 
			AND K.CODORDEM=KO.CODORDEM
			INNER JOIN KORDEMCOMPL KL ON
			KL.CODCOLIGADA=K.CODCOLIGADA
			AND KL.CODFILIAL=K.CODFILIAL
			AND KL.CODORDEM=K.CODORDEM
			INNER JOIN KATVORDEM KA ON KA.CODCOLIGADA = K.CODCOLIGADA AND KA.CODFILIAL = K.CODFILIAL AND KA.CODORDEM = K.CODORDEM
			LEFT JOIN FLUIG.DBO.Z_CRM_EX001005 E
			ON E.CODCOLIGADA=K.CODCOLIGADA
			AND E.CODFILIAL=E.CODFILIAL
			AND E.OS=K.CODCCUSTO COLLATE SQL_Latin1_General_CP1_CI_AI
			AND E.CODIGOPRD=K.CODESTRUTURA COLLATE SQL_Latin1_General_CP1_CI_AI
			AND E.EXECUCAO=KL.NUMEXEC
			WHERE E.IDCRIACAO IS NULL AND K.STATUS!=6 AND K.CODCCUSTO=@NUM_OS AND ISNULL(KO.REPROCESSAMENTO,0)!=1 AND KL.NUMEXEC=@EXECUCAO AND KO.RESPONSAVEL LIKE CONCAT('%/',@CODTRFPAI,'%')

		COMMIT

		
		/**************************************************************************************************************************************************************
		
			CANCELA ITEM DA ORDEM DE PRODUÇÃO QUE FOI EXCLUÍDA DA ESTRUTURA DE EXECUÇÃO

		***************************************************************************************************************************************************************/

		BEGIN TRAN

			UPDATE KO SET STATUS=6
			FROM 
			KITEMORDEM K INNER JOIN KORDEM KO 
			ON K.CODCOLIGADA=KO.CODCOLIGADA 
			AND K.CODFILIAL=KO.CODFILIAL 
			AND K.CODORDEM=KO.CODORDEM
			INNER JOIN KORDEMCOMPL KL ON
			KL.CODCOLIGADA=K.CODCOLIGADA
			AND KL.CODFILIAL=K.CODFILIAL
			AND KL.CODORDEM=K.CODORDEM
			INNER JOIN KATVORDEM KA ON KA.CODCOLIGADA = K.CODCOLIGADA AND KA.CODFILIAL = K.CODFILIAL AND KA.CODORDEM = K.CODORDEM
			LEFT JOIN FLUIG.DBO.Z_CRM_EX001005 E
			ON E.CODCOLIGADA=K.CODCOLIGADA
			AND E.CODFILIAL=E.CODFILIAL
			AND E.OS=K.CODCCUSTO COLLATE SQL_Latin1_General_CP1_CI_AI
			AND E.CODIGOPRD=K.CODESTRUTURA COLLATE SQL_Latin1_General_CP1_CI_AI
			AND E.EXECUCAO=KL.NUMEXEC
			WHERE E.IDCRIACAO IS NULL AND KO.STATUS!=6 AND K.CODCCUSTO=@NUM_OS AND ISNULL(KO.REPROCESSAMENTO,0)!=1 AND KL.NUMEXEC=@EXECUCAO AND KO.RESPONSAVEL LIKE CONCAT('%/',@CODTRFPAI,'%')

		COMMIT

		
		/**************************************************************************************************************************************************************
		
				CANCELA A ORDEM DE PRODUÇÃO QUE FOI EXCLUÍDA DA ESTRUTURA DE EXECUÇÃO

		***************************************************************************************************************************************************************/


		BEGIN TRAN 

			UPDATE KA SET STATUS=6
			FROM 
			KITEMORDEM K INNER JOIN KORDEM KO 
			ON K.CODCOLIGADA=KO.CODCOLIGADA 
			AND K.CODFILIAL=KO.CODFILIAL 
			AND K.CODORDEM=KO.CODORDEM
			INNER JOIN KORDEMCOMPL KL ON
			KL.CODCOLIGADA=K.CODCOLIGADA
			AND KL.CODFILIAL=K.CODFILIAL
			AND KL.CODORDEM=K.CODORDEM
			INNER JOIN KATVORDEM KA ON KA.CODCOLIGADA = K.CODCOLIGADA AND KA.CODFILIAL = K.CODFILIAL AND KA.CODORDEM = K.CODORDEM
			LEFT JOIN FLUIG.DBO.Z_CRM_EX001005 E
			ON E.CODCOLIGADA=K.CODCOLIGADA
			AND E.CODFILIAL=E.CODFILIAL
			AND E.OS=K.CODCCUSTO COLLATE SQL_Latin1_General_CP1_CI_AI
			AND E.CODIGOPRD=K.CODESTRUTURA COLLATE SQL_Latin1_General_CP1_CI_AI
			AND E.EXECUCAO=KL.NUMEXEC
			WHERE E.IDCRIACAO IS NULL AND KA.STATUS!=6 AND K.CODCCUSTO=@NUM_OS AND ISNULL(KO.REPROCESSAMENTO,0)!=1 AND KL.NUMEXEC=@EXECUCAO AND KO.RESPONSAVEL LIKE CONCAT('%/',@CODTRFPAI,'%')

		COMMIT

		/**************************************************************************************************************************************************************
		
			CANCELA AS ATIVIDADES DA ORDEM DE PRODUÇÃO QUE FOI EXCLUÍDA DA ESTRUTURA DE EXECUÇÃO

		***************************************************************************************************************************************************************/

	END 

	BEGIN TRAN 

		DELETE C FROM FLUIG.DBO.Z_CRM_EX001005(NOLOCK) I
		LEFT JOIN FLUIG.DBO.Z_CRM_EX001019 C ON C.OSCOMPONENTES=I.OS AND C.EXECUCAO=I.EXECUCAO AND C.IDCRIACAOCOMPONENTES=I.IDCRIACAO
		WHERE I.OS=@NUM_OS AND I.EXECUCAO=@EXECUCAO AND I.CODTRFPAI=@CODTRFPAI AND I.ITEMEXCLUSIVO=2 AND I.IDCRIACAO=ISNULL(@IDCRIACAO,I.IDCRIACAO) 

	COMMIT

	/**************************************************************************************************************************************************************
		
		DELETA OS COMPONENTES DOS ITENS QUE FORAM EXCLUÍDOS DA ESTRUTRA

	***************************************************************************************************************************************************************/	

	BEGIN TRAN 

		DELETE A FROM FLUIG.DBO.Z_CRM_EX001005(NOLOCK) I
		LEFT JOIN FLUIG.DBO.Z_CRM_EX001021 A ON A.OSPROCESSO=I.OS AND A.EXECUCAO=I.EXECUCAO AND A.IDCRIACAOPROCESSO=I.IDCRIACAO
		WHERE I.OS=@NUM_OS AND I.EXECUCAO=@EXECUCAO AND I.CODTRFPAI=@CODTRFPAI AND I.ITEMEXCLUSIVO=2 AND I.IDCRIACAO=ISNULL(@IDCRIACAO,I.IDCRIACAO) 

	COMMIT

	/**************************************************************************************************************************************************************
		
		DELETA AS ATIVIDADES DOS ITENS QUE FORAM EXCLUÍDOS DA ESTRUTRA

	***************************************************************************************************************************************************************/	

	BEGIN TRAN 

		DELETE I FROM FLUIG.DBO.Z_CRM_EX001005 I WITH (NOLOCK)
		WHERE OS=@NUM_OS AND EXECUCAO=@EXECUCAO AND CODTRFPAI=@CODTRFPAI AND ITEMEXCLUSIVO=2 AND I.IDCRIACAO=ISNULL(@IDCRIACAO,I.IDCRIACAO) 

	COMMIT;

	/**************************************************************************************************************************************************************
		
		DELETA OS ITENS QUE FORAM EXCLUÍDOS DA ESTRUTRA

	***************************************************************************************************************************************************************/

	BEGIN TRAN

		UPDATE Z SET ITEMDERETORNO=NULL FROM FLUIG.DBO.Z_CRM_EX001005 Z
		LEFT JOIN FLUIG.DBO.Z_CRM_EX001005 R ON
		Z.CODCOLIGADA=R.CODCOLIGADA
		AND Z.CODFILIAL=R.CODFILIAL
		AND Z.OS=R.OS
		AND Z.EXECUCAO=R.EXECUCAO
		AND Z.ITEMDERETORNO=R.IDCRIACAO
		WHERE R.IDCRIACAO IS NULL AND Z.ITEMDERETORNO !='' AND Z.ITEMDERETORNO IS NOT NULL

	COMMIT

	/**************************************************************************************************************************************************************
		
		LIMPA ITENS DE RETORNO EXCLUÍDOS

	***************************************************************************************************************************************************************/	
	/**************************************************************************************************************************************************************
		
		EXCLUI OS ITENS QUE POSSUEM O CAMPO 'ITEMEXCLUSIVO' IGUAL A 2, NA SEQUÊNCIA : COMPONENTES, ATIVIDADES, ESTRUTURA

	***************************************************************************************************************************************************************/

	IF @IDCRIACAO IS NULL
	BEGIN
		EXEC FLUIG.DBO.SP_DELP_REINDEXAEXECUCAO @NUM_OS,@EXECUCAO,@CODTRFPAI
	END

	/**************************************************************************************************************************************************************
		
		ATUALIZA A INFORMAÇÃO DE INDICE E NÍVEL DA ESTRUTURA BASEADO NA INFORMAÇÃO DE IDCRIACAO E IDCRIACAOPAI;
		ATUALIZA A INFORMAÇÃO DE CODTRFPAI DE TODOS OS ITENS DA ESTRUTURA, BASEANDO NO INDICE PARA BUSCAR O ITEM PAI PRINCIPAL 

	***************************************************************************************************************************************************************/

	BEGIN TRAN 

		UPDATE P SET  P.INVENTARIOFISCAL = 1, P.TIPOTRIBUTACAO = 0, P.CODCOLCONTA = @CODCOLIGADA,
					P.SITUACAOMERCADORIA = CASE LEFT(I.CODIGOPRD,2) 
													WHEN '04' THEN '04' 
													WHEN '03' THEN '03'
													ELSE '02'  END, 
					P.CODCONTA = CASE WHEN LEFT(I.CODIGOPRD,2) = '04' THEN '1.1.3.01.0003' ELSE  '1.1.3.01.0004' END 
		FROM FLUIG.dbo.Z_CRM_EX001005 (NOLOCK) I
			INNER JOIN TPRDFISCAL P ON P.CODCOLIGADA = I.CODCOLIGADA AND I.IDPRD = P.IDPRD
			LEFT JOIN FLUIG.dbo.Z_CRM_ML001005 (NOLOCK) T ON I.OS = T.OS AND I.IDCRIACAO = T.IDCRIACAO
		WHERE T.ID IS NULL AND @NUM_OS = I.OS AND @EXECUCAO = I.EXECUCAO AND @CODTRFPAI = I.CODTRFPAI AND I.IDCRIACAO=ISNULL(@IDCRIACAO,I.IDCRIACAO) ;

	COMMIT

	/**************************************************************************************************************************************************************
		
		ATUALIZA OS DADOS FISCAIS DOS PRODUTOS EXCLUSIVOS EXISTENTES DAQUELA EXECUCAO

	***************************************************************************************************************************************************************/	

	BEGIN TRAN 

		UPDATE P SET P.DESCRICAO = ISNULL(I.DESCRICAO,'')+' - '+ISNULL(I.POSICAODESENHO,'')+' - '+ISNULL(I.NUMDESENHO,''), 
					 P.NOMEFANTASIA = LEFT(ISNULL(I.DESCRICAO,'')+' - '+ISNULL(I.POSICAODESENHO,'')+' - '+ISNULL(I.NUMDESENHO,''),120)
		FROM FLUIG.dbo.Z_CRM_EX001005 (NOLOCK) I 
			INNER JOIN TPRODUTO P ON P.CODCOLPRD = 1 AND I.IDPRD = P.IDPRD
			LEFT JOIN FLUIG.dbo.Z_CRM_ML001005 (NOLOCK) T ON I.OS = T.OS AND I.IDCRIACAO = T.IDCRIACAO
		WHERE T.ID IS NULL AND @NUM_OS = I.OS AND @EXECUCAO = I.EXECUCAO AND @CODTRFPAI = I.CODTRFPAI AND LEFT(P.CODIGOPRD,2)!='04' AND I.IDCRIACAO=ISNULL(@IDCRIACAO,I.IDCRIACAO) ;

	COMMIT

	/**************************************************************************************************************************************************************
		
		ATUALIZA A DESCRIÇÃO DOS PRODUTOS EXCLUSIVOS DAQUELA EXECUÇÃO, BASEADO NA EXECUÇÃO DO FLUIG, EXCETO OS PRODUTOS ACABADOS, O CÓDIGO DELES INICIA COM 04

	***************************************************************************************************************************************************************/

	BEGIN TRAN 
		
		UPDATE P SET P.NUMNOFABRIC = I.CODIGOPRD
		FROM  FLUIG.dbo.Z_CRM_EX001005 (NOLOCK) I 
			INNER JOIN TPRODUTODEF P ON P.CODCOLIGADA = 1 AND I.IDPRD = P.IDPRD
			LEFT JOIN FLUIG.dbo.Z_CRM_ML001005 (NOLOCK) T ON I.OS = T.OS AND I.IDCRIACAO = T.IDCRIACAO
		WHERE T.ID IS NULL AND @NUM_OS = I.OS AND @EXECUCAO = I.EXECUCAO AND @CODTRFPAI = I.CODTRFPAI AND I.IDCRIACAO=ISNULL(@IDCRIACAO,I.IDCRIACAO) ;

	COMMIT

	/**************************************************************************************************************************************************************
		
		ATUALIZA O NUMERO DO FABRICANTE DO PRODUTO PARA SER IGUAL AO CÓDIGO DOS PRODUTOSEXCLUSIVOS

	***************************************************************************************************************************************************************/

	DECLARE @CODCOLIGADA_EST INT,@CODIGOPRD_EST VARCHAR(30),@CODTIPO_EST VARCHAR(1),@IDPRODUTO_EST INT,@QTDLOTE_EST INT, @STATUSESTR_EST INT, @CODCCUSTO_EST VARCHAR(25),
	@IDFASE_EST INT,@FASEVALIDADA_EST INT, @CODIGOULTALTERACAO_EST INT, @VALIDACAOSOLICITADA_EST INT, @CODFILIAL_EST INT, @IDCRIACAO_EST INT, @ORDENACAO_EST HIERARCHYID

	DECLARE ITENS_EST CURSOR FOR 

		SELECT DISTINCT I.CODCOLIGADA, I.CODIGOPRD, CASE WHEN LEFT(I.CODIGOPRD,2) = '04' THEN 'A' ELSE 'S' END, I.IDPRD, I.DESQTDE*10000, 1, I.OS, 1, 1, 0, 0, I.CODFILIAL,I.IDCRIACAO,CAST('/' + REPLACE(I.INDICE, '.', '/') + '/' AS HIERARCHYID) ORDENACAO
		FROM FLUIG.dbo.Z_CRM_EX001005 (NOLOCK) I
			LEFT JOIN FLUIG.dbo.Z_CRM_ML001005 (NOLOCK) P ON I.OS = P.OS AND I.IDCRIACAO = P.IDCRIACAO
			LEFT JOIN KESTRUTURA E ON I.CODCOLIGADA = E.CODCOLIGADA AND I.CODIGOPRD COLLATE SQL_Latin1_General_CP1_CI_AI = E.CODESTRUTURA AND E.CODFILIAL = I.CODFILIAL
			INNER JOIN FLUIG.dbo.Z_CRM_EX001021 A ON A.OSPROCESSO=I.OS AND A.IDCRIACAOPROCESSO=I.IDCRIACAO
			INNER JOIN (
				SELECT  I.*
				FROM  FLUIG.dbo.Z_CRM_EX001005 (NOLOCK) I 
					INNER JOIN FLUIG.dbo.Z_CRM_EX001005 (NOLOCK) E ON I.OS = E.OS AND I.IDCRIACAO = E.IDCRIACAOPAI  AND E.EXECUCAO = I.EXECUCAO
				WHERE @NUM_OS = I.OS AND @EXECUCAO = I.EXECUCAO AND @CODTRFPAI = I.CODTRFPAI  AND I.TIPODESENHO NOT IN ('NAOMANUFATURADO','INDUSTRIALIZACAO') AND COALESCE(E.ITEMDERETORNO,0)=0 AND I.IDCRIACAO=ISNULL(@IDCRIACAO,I.IDCRIACAO) 
							
				UNION

				SELECT  I.*
				FROM  FLUIG.DBO.Z_CRM_EX001005 (NOLOCK) I 
					INNER JOIN FLUIG.DBO.Z_CRM_EX001019 (NOLOCK) E ON I.OS = E.OSCOMPONENTES AND I.IDCRIACAO = E.IDCRIACAOCOMPONENTES  AND E.EXECUCAO = I.EXECUCAO
				WHERE @NUM_OS = I.OS AND @EXECUCAO = I.EXECUCAO AND @CODTRFPAI = I.CODTRFPAI  AND I.TIPODESENHO NOT IN ('NAOMANUFATURADO','INDUSTRIALIZACAO') AND I.IDCRIACAO=ISNULL(@IDCRIACAO,I.IDCRIACAO) 

				UNION
					-- CODIGOS NÃO MANUFATURADO
				SELECT P.*
				FROM FLUIG.dbo.Z_CRM_EX001005 (NOLOCK) I 
					INNER JOIN FLUIG.dbo.Z_CRM_EX001019 (NOLOCK) C ON I.OS = C.OSCOMPONENTES AND C.IDCRIACAOCOMPONENTES = I.IDCRIACAO  AND C.EXECUCAO = I.EXECUCAO
					INNER JOIN FLUIG.dbo.Z_CRM_EX001005 (NOLOCK) P ON I.OS = P.OS AND I.IDCRIACAO = P.IDCRIACAOPAI  AND P.EXECUCAO = I.EXECUCAO
				WHERE ISNULL(SUBSTITUTOCOMPONENTES,'') = '' AND   @NUM_OS = I.OS AND @EXECUCAO = I.EXECUCAO AND @CODTRFPAI = I.CODTRFPAI AND I.TIPODESENHO = 'NAOMANUFATURADO' AND I.IDCRIACAO=ISNULL(@IDCRIACAO,I.IDCRIACAO) 

			) C ON C.OS=I.OS AND C.IDCRIACAO=I.IDCRIACAO AND C.EXECUCAO=I.EXECUCAO
		WHERE P.ID IS NULL AND I.IDPRD IS NOT NULL AND I.IDPRD!='' AND E.CODESTRUTURA IS NULL AND @NUM_OS = I.OS AND @EXECUCAO = I.EXECUCAO AND @CODTRFPAI = I.CODTRFPAI AND I.TIPODESENHO NOT IN ('NAOMANUFATURADO','INDUSTRIALIZACAO') 
		AND (C.IDCRIACAO IS NOT NULL OR I.OS LIKE '%.60.%' OR I.OS LIKE '%.80.%' OR I.OS IN ('3.07905.32.001'))
		ORDER BY CAST('/' + REPLACE(I.INDICE, '.', '/') + '/' AS HIERARCHYID) DESC

	OPEN ITENS_EST

	FETCH NEXT FROM ITENS_EST INTO @CODCOLIGADA_EST,@CODIGOPRD_EST,@CODTIPO_EST,@IDPRODUTO_EST,@QTDLOTE_EST, @STATUSESTR_EST, @CODCCUSTO_EST,
	@IDFASE_EST,@FASEVALIDADA_EST, @CODIGOULTALTERACAO_EST, @VALIDACAOSOLICITADA_EST, @CODFILIAL_EST,@IDCRIACAO_EST, @ORDENACAO_EST 

	WHILE @@FETCH_STATUS = 0 
	BEGIN

		BEGIN TRAN 	

			IF NOT EXISTS(  -- NÃO EXISTE ITEM FILHO SEM ESTRUTURA
					
				SELECT DISTINCT I.IDCRIACAO
				FROM FLUIG.dbo.Z_CRM_EX001005 (NOLOCK) I 
				LEFT JOIN KESTRUTURA E ON I.CODCOLIGADA = E.CODCOLIGADA AND I.CODIGOPRD COLLATE SQL_Latin1_General_CP1_CI_AI = E.CODESTRUTURA AND E.CODFILIAL = I.CODFILIAL
				WHERE I.CODCOLIGADA=@CODCOLIGADA AND I.CODFILIAL=@CODFILIAL AND I.OS=@NUM_OS AND I.IDCRIACAOPAI=@IDCRIACAO_EST AND E.CODESTRUTURA IS NULL AND I.TIPODESENHO NOT IN ('NAOMANUFATURADO','INDUSTRIALIZACAO') AND @EXECUCAO = I.EXECUCAO


			) AND NOT EXISTS ( -- NÃO EXISTE ITEM FILHO NÃO MANUFATURADO COM PENDENCIA 
				
				SELECT DISTINCT I.IDCRIACAO
				FROM FLUIG.dbo.Z_CRM_EX001005 (NOLOCK) I 
				INNER JOIN FLUIG.DBO.Z_DELP_PENDNAOMANUFATURADO_EX E ON I.CODCOLIGADA = E.CODCOLIGADA AND I.OS=E.OS AND I.IDCRIACAO=E.IDCRIACAO AND I.EXECUCAO=E.EXECUCAO
				WHERE I.CODCOLIGADA=@CODCOLIGADA AND I.CODFILIAL=@CODFILIAL AND I.OS=@NUM_OS AND I.IDCRIACAOPAI=@IDCRIACAO_EST AND @EXECUCAO = I.EXECUCAO
			) AND NOT EXISTS ( -- NÃO EXISTE ITEM FILHO INDUSTRIALIZADO COM PENDENCIA 
				
				SELECT DISTINCT I.IDCRIACAO
				FROM FLUIG.dbo.Z_CRM_EX001005 (NOLOCK) I 
				INNER JOIN FLUIG.DBO.Z_DELP_PENDINDUSTRIALIZADO_EX E ON I.CODCOLIGADA = E.CODCOLIGADA AND I.OS=E.OS AND I.IDCRIACAO=E.IDCRIACAO AND I.EXECUCAO=E.EXECUCAO
				WHERE I.CODCOLIGADA=@CODCOLIGADA AND I.CODFILIAL=@CODFILIAL AND I.OS=@NUM_OS AND I.IDCRIACAOPAI=@IDCRIACAO_EST AND @EXECUCAO = I.EXECUCAO
			)

			BEGIN

				INSERT INTO KESTRUTURA (CODCOLIGADA, CODESTRUTURA, CODTIPO, IDPRODUTO, QTDLOTE, STATUSESTR, CODCCUSTO, IDFASE, FASEVALIDADA, CODIGOULTALTERACAO, VALIDACAOSOLICITADA, CODFILIAL, RECCREATEDBY, RECCREATEDON, RECMODIFIEDBY, RECMODIFIEDON)
					VALUES (@CODCOLIGADA_EST,@CODIGOPRD_EST,@CODTIPO_EST,@IDPRODUTO_EST,@QTDLOTE_EST, @STATUSESTR_EST, @CODCCUSTO_EST,
					@IDFASE_EST,@FASEVALIDADA_EST, @CODIGOULTALTERACAO_EST, @VALIDACAOSOLICITADA_EST, @CODFILIAL_EST, 'fluig', GETDATE(),'fluig', GETDATE())

			END

		COMMIT 

		FETCH NEXT FROM ITENS_EST INTO @CODCOLIGADA_EST,@CODIGOPRD_EST,@CODTIPO_EST,@IDPRODUTO_EST,@QTDLOTE_EST, @STATUSESTR_EST, @CODCCUSTO_EST,
			@IDFASE_EST,@FASEVALIDADA_EST, @CODIGOULTALTERACAO_EST, @VALIDACAOSOLICITADA_EST, @CODFILIAL_EST,@IDCRIACAO_EST, @ORDENACAO_EST

	END
	CLOSE ITENS_EST;
	DEALLOCATE ITENS_EST;

	/**************************************************************************************************************************************************************
		
		INSERE AS ESTRUTURAS DE FABRICAÇÃO DO PROEJTO CASO AINDA NÃO EXISTAM E SEGUINDO AS REGRAS:
			- ITEM DEVE SER DO TIPODESENHO : SEMIACABADO OU ACABADO
			- ITEM DEVE POSSUIR ATIVIDADES CADASTRADAS 
			- ITEM DEVE POSSUIR COMPONENTES OU FILHOS ( EXCETO PROJETOS .60., .80., E EXCEÇÕES )

	***************************************************************************************************************************************************************/


	BEGIN TRAN 

		UPDATE K  SET CODTIPO = CASE WHEN LEFT(I.CODIGOPRD,2) = '04' THEN 'A' ELSE 'S' END, QTDLOTE = ISNULL(I.DESQTDE,1)*10000, STATUSESTR= 1,  RECMODIFIEDON = GETDATE()
		FROM FLUIG.dbo.Z_CRM_EX001005 (NOLOCK) I
			INNER JOIN KESTRUTURA K ON I.CODCOLIGADA = K.CODCOLIGADA AND I.CODIGOPRD COLLATE SQL_Latin1_General_CP1_CI_AI = K.CODESTRUTURA AND K.CODFILIAL = I.CODFILIAL
			LEFT JOIN FLUIG.dbo.Z_CRM_ML001005 (NOLOCK) P ON I.OS = P.OS AND I.IDCRIACAO = P.IDCRIACAO
		WHERE  P.ID IS NULL AND I.OS = @NUM_OS  AND I.IDCRIACAO=ISNULL(@IDCRIACAO,I.IDCRIACAO) AND @EXECUCAO = I.EXECUCAO AND @CODTRFPAI = I.CODTRFPAI AND I.TIPODESENHO NOT IN ('NAOMANUFATURADO','INDUSTRIALIZACAO');

	COMMIT

	/**************************************************************************************************************************************************************
		
		ATUALIZA AS INFORMAÇÕES DAS ESTRUTURAS EXCLUSIVAS JÁ CADASTRADAS ANTERIORMENTE

	***************************************************************************************************************************************************************/

	BEGIN TRAN 

		INSERT INTO KLINHAEST (CODCOLIGADA, CODLINHA, CODESTRUTURA, CODFILIAL, RECCREATEDBY, RECCREATEDON, RECMODIFIEDBY, RECMODIFIEDON)
		SELECT DISTINCT I.CODCOLIGADA, '001', I.CODIGOPRD, I.CODFILIAL, 'fluig', GETDATE(),'fluig', GETDATE() 
		FROM FLUIG.dbo.Z_CRM_EX001005 (NOLOCK) I
			INNER JOIN KESTRUTURA K ON I.CODCOLIGADA = K.CODCOLIGADA AND I.CODIGOPRD COLLATE SQL_Latin1_General_CP1_CI_AI = K.CODESTRUTURA AND K.CODFILIAL = I.CODFILIAL
			LEFT JOIN FLUIG.dbo.Z_CRM_ML001005 (NOLOCK) P ON I.OS = P.OS AND I.IDCRIACAO = P.IDCRIACAO
			LEFT JOIN KLINHAEST E ON I.CODCOLIGADA = E.CODCOLIGADA AND I.CODIGOPRD COLLATE SQL_Latin1_General_CP1_CI_AI = E.CODESTRUTURA AND E.CODFILIAL = I.CODFILIAL
		WHERE  P.ID IS NULL AND E.CODESTRUTURA IS NULL AND @NUM_OS = I.OS AND @EXECUCAO = I.EXECUCAO AND @CODTRFPAI = I.CODTRFPAI AND I.TIPODESENHO NOT IN ('NAOMANUFATURADO','INDUSTRIALIZACAO') AND I.IDCRIACAO=ISNULL(@IDCRIACAO,I.IDCRIACAO) 

	COMMIT

	/**************************************************************************************************************************************************************
		
		INSERE AS INFORMAÇÕES DA LINHA DE PRODUÇÃO DAS ESTRUTURAS EXCLUSIVAS CASO NÃO EXISTAM

	***************************************************************************************************************************************************************/

	BEGIN TRAN 

		INSERT INTO KESTRUTURACOMPL (CODCOLIGADA, CODESTRUTURA, CODFILIAL, ELABORADOR2, ELABORADOR3, ELABORADOR, CAMDESENHO, NUMREVISAO, POSICAO, BITOLA, LARGURA, COMPRIMENTO, PESOBRUTO, PESOLIQUIDO, ESPECIFICACAOROSCA , RECCREATEDBY, RECCREATEDON, RECMODIFIEDBY, RECMODIFIEDON)
		SELECT			DISTINCT			 I.CODCOLIGADA, I.CODIGOPRD, I.CODFILIAL, NULL ELABORADOR2, NULL ELABORADOR3, NULL ELABORADOR, 
								CASE WHEN I.NUMDESENHO = '' THEN NULL ELSE I.NUMDESENHO END, 
								CASE WHEN I.REVISAODESENHO = '' THEN NULL ELSE I.REVISAODESENHO END, 
								CASE WHEN I.POSICAODESENHO = '' THEN NULL ELSE I.POSICAODESENHO END, 
								CAST( CASE WHEN I.BITOLA = '' OR I.BITOLA = 'null' THEN NULL ELSE REPLACE(I.BITOLA,',','.') END AS FLOAT), 
								CAST( CASE WHEN I.LARGURA = '' OR I.LARGURA = 'null' THEN NULL ELSE REPLACE(I.LARGURA,',','.') END AS FLOAT),
								CAST( CASE WHEN I.COMPRIMENTO = '' OR I.COMPRIMENTO = 'null' THEN NULL ELSE REPLACE(I.COMPRIMENTO,',','.') END AS FLOAT), 
								CAST( CASE WHEN I.PESOBRUTO = '' OR I.PESOBRUTO = 'null' THEN NULL ELSE REPLACE(I.PESOBRUTO,',','.') END AS FLOAT), 
								CAST( CASE WHEN I.PESOLIQUIDO = '' OR I.PESOLIQUIDO = 'null' THEN NULL ELSE REPLACE(I.PESOLIQUIDO,',','.') END AS FLOAT), 
								CASE WHEN I.ESPROSCA = '' OR I.ESPROSCA = 'null' THEN NULL ELSE I.ESPROSCA END, 'fluig', GETDATE(),'fluig', GETDATE() 
		FROM FLUIG.dbo.Z_CRM_EX001005 (NOLOCK) I 
			INNER JOIN KESTRUTURA KE ON I.CODCOLIGADA = KE.CODCOLIGADA AND I.CODIGOPRD COLLATE SQL_Latin1_General_CP1_CI_AI = KE.CODESTRUTURA AND KE.CODFILIAL = I.CODFILIAL
			LEFT JOIN FLUIG.dbo.Z_CRM_ML001005 (NOLOCK) P ON I.OS = P.OS AND I.IDCRIACAO = P.IDCRIACAO
			LEFT JOIN KESTRUTURACOMPL K ON K.CODCOLIGADA = 1 AND K.CODFILIAL = I.CODFILIAL AND K.CODESTRUTURA = I.CODIGOPRD COLLATE SQL_Latin1_General_CP1_CI_AI
		WHERE  P.ID IS NULL AND  K.CODESTRUTURA IS NULL
		AND @NUM_OS = I.OS AND @EXECUCAO = I.EXECUCAO AND @CODTRFPAI = I.CODTRFPAI AND I.TIPODESENHO NOT IN ('NAOMANUFATURADO','INDUSTRIALIZACAO') AND I.IDCRIACAO=ISNULL(@IDCRIACAO,I.IDCRIACAO) 

	COMMIT

	/**************************************************************************************************************************************************************
		
		INSERE AS INFORMAÇÕES COMPLEMENTARES DAS ESTRUTURAS EXCLUSIVAS DE FABRICAÇÃO CASO NÃO EXISTAM

	***************************************************************************************************************************************************************/

	BEGIN TRAN 

		UPDATE K SET	CAMDESENHO =	CASE WHEN I.NUMDESENHO = '' THEN NULL ELSE I.NUMDESENHO END, 
						NUMREVISAO =		CASE WHEN I.REVISAODESENHO = '' THEN NULL ELSE I.REVISAODESENHO END, 
						POSICAO    =		CASE WHEN I.POSICAODESENHO = '' THEN NULL ELSE I.POSICAODESENHO END, 
						BITOLA     =		CAST( CASE WHEN I.BITOLA = '' THEN NULL ELSE REPLACE(I.BITOLA,',','.') END AS FLOAT), 
						LARGURA    =		CAST( CASE WHEN I.LARGURA = '' THEN NULL ELSE REPLACE(I.LARGURA,',','.') END AS FLOAT),
						COMPRIMENTO=		CAST( CASE WHEN I.COMPRIMENTO = '' THEN NULL ELSE REPLACE(I.COMPRIMENTO,',','.') END AS FLOAT), 
						PESOBRUTO  =		CAST( CASE WHEN I.PESOBRUTO = '' THEN NULL ELSE REPLACE(I.PESOBRUTO,',','.') END AS FLOAT), 
						PESOLIQUIDO=		CAST( CASE WHEN I.PESOLIQUIDO = '' THEN NULL ELSE REPLACE(I.PESOLIQUIDO,',','.') END AS FLOAT), 
						ESPECIFICACAOROSCA=		CASE WHEN I.ESPROSCA = '' THEN NULL ELSE I.ESPROSCA END, 
						RECMODIFIEDON = GETDATE() 
		FROM FLUIG.dbo.Z_CRM_EX001005 (NOLOCK) I 
			INNER JOIN KESTRUTURACOMPL K ON K.CODCOLIGADA = I.CODCOLIGADA AND K.CODFILIAL = I.CODFILIAL AND K.CODESTRUTURA = I.CODIGOPRD COLLATE SQL_Latin1_General_CP1_CI_AI
			LEFT JOIN FLUIG.dbo.Z_CRM_ML001005 (NOLOCK) P ON I.OS = P.OS AND I.IDCRIACAO = P.IDCRIACAO
		WHERE  P.ID IS NULL AND @NUM_OS = I.OS AND @EXECUCAO = I.EXECUCAO AND @CODTRFPAI = I.CODTRFPAI AND I.TIPODESENHO NOT IN ('NAOMANUFATURADO','INDUSTRIALIZACAO') AND I.IDCRIACAO=ISNULL(@IDCRIACAO,I.IDCRIACAO)

	COMMIT

	
	/**************************************************************************************************************************************************************
		
		ATUALIZA AS INFORMAÇÕES COMPLEMENTARES DAS ATIVIDADES DAS ESTRUTURA EXCLUSIVAS DE FABRICAÇÃO 

	***************************************************************************************************************************************************************/

	BEGIN TRAN 

		DELETE K
		FROM  FLUIG.dbo.Z_CRM_EX001005 (NOLOCK) I 
				INNER JOIN KATVESTRUTURACOMPL K ON K.CODCOLIGADA = I.CODCOLIGADA AND K.CODFILIAL = I.CODFILIAL  AND K.CODESTRUTURA = I.CODIGOPRD COLLATE SQL_Latin1_General_CP1_CI_AI
				LEFT JOIN FLUIG.dbo.Z_CRM_ML001005 (NOLOCK) P ON I.OS = P.OS AND I.IDCRIACAO = P.IDCRIACAO
		WHERE P.ID IS NULL AND I.OS = @NUM_OS AND I.IDCRIACAO=ISNULL(@IDCRIACAO,I.IDCRIACAO);

	COMMIT

	/**************************************************************************************************************************************************************
		
		DELETA AS INFORMAÇÕES COMPLEMENTARES DAS ATIVIDADES DAS ESTRUTURAS EXCLUSIVAS PARA SEREM RECRIADAS

	***************************************************************************************************************************************************************/

	BEGIN TRAN 

		DELETE K
		FROM FLUIG.dbo.Z_CRM_EX001005 (NOLOCK) I
				INNER JOIN KATVESTPOSTO K ON K.CODCOLIGADA = 1 AND K.CODFILIAL = I.CODFILIAL  AND K.CODESTRUTURA = I.CODIGOPRD COLLATE SQL_Latin1_General_CP1_CI_AI
				LEFT JOIN FLUIG.dbo.Z_CRM_ML001005 (NOLOCK) P ON I.OS = P.OS AND I.IDCRIACAO = P.IDCRIACAO
		WHERE P.ID IS NULL AND I.OS = @NUM_OS AND I.IDCRIACAO=ISNULL(@IDCRIACAO,I.IDCRIACAO);

	COMMIT

	/**************************************************************************************************************************************************************
		 
		DELETA AS INFORMAÇÕES DE POSTO DAS ATIVIDADES DAS ESTRUTURAS EXCLUSIVAS PARA SEREM RECRIADAS

	***************************************************************************************************************************************************************/

	BEGIN TRAN 		
		
		DELETE K
		FROM FLUIG.dbo.Z_CRM_EX001005 (NOLOCK) I 
				INNER JOIN KCOMPSUBSTITUTO K ON K.CODCOLIGADA = 1 AND K.CODFILIAL = I.CODFILIAL AND K.CODESTRUTURA = I.CODIGOPRD  COLLATE SQL_Latin1_General_CP1_CI_AI
				LEFT JOIN FLUIG.dbo.Z_CRM_ML001005 (NOLOCK) P ON I.OS = P.OS AND I.IDCRIACAO = P.IDCRIACAO
		WHERE P.ID IS NULL AND I.OS = @NUM_OS AND I.IDCRIACAO=ISNULL(@IDCRIACAO,I.IDCRIACAO);

	COMMIT

	/**************************************************************************************************************************************************************
		
		DELETA AS INFORMAÇÕES DE COMPONENTES SUBSTITUTOS DAS ESTRUTURAS EXCLUSIVAS PARA SEREM RECRIADAS

	***************************************************************************************************************************************************************/

	BEGIN TRAN 		
		
		DELETE K
		FROM FLUIG.dbo.Z_CRM_EX001005 (NOLOCK) I 
				INNER JOIN KCOMPONENTECOMPL K ON K.CODCOLIGADA = I.CODCOLIGADA AND K.CODFILIAL = I.CODFILIAL AND K.CODESTRUTURA = I.CODIGOPRD  COLLATE SQL_Latin1_General_CP1_CI_AI
				INNER JOIN KCOMPONENTE KK ON K.CODCOLIGADA=KK.CODCOLIGADA AND K.CODFILIAL=KK.CODFILIAL AND K.CODESTRUTURA=KK.CODESTRUTURA AND K.IDPRODUTO=KK.IDPRODUTO AND K.CODATIVIDADE=KK.CODATIVIDADE
				LEFT JOIN FLUIG.dbo.Z_CRM_ML001005 (NOLOCK) P ON I.OS = P.OS AND I.IDCRIACAO = P.IDCRIACAO
		WHERE P.ID IS NULL AND I.OS = @NUM_OS AND I.IDPRD <> '' AND KK.TIPOAGRUPADOR=0 AND I.IDCRIACAO=ISNULL(@IDCRIACAO,I.IDCRIACAO);

	COMMIT

	/**************************************************************************************************************************************************************
		
		DELETA AS INFORMAÇÕES COMPLEMENTARES DOS COMPONENTES DAS ESTRUTURAS EXCLUSIVAS PARA SEREM RECRIADAS

	***************************************************************************************************************************************************************/

	BEGIN TRAN 

		DELETE K
		FROM FLUIG.dbo.Z_CRM_EX001005 (NOLOCK) I
				INNER JOIN KCOMPONENTE K ON K.CODCOLIGADA = I.CODCOLIGADA AND K.CODFILIAL = I.CODFILIAL AND K.CODESTRUTURA = I.CODIGOPRD  COLLATE SQL_Latin1_General_CP1_CI_AI
				LEFT JOIN FLUIG.dbo.Z_CRM_ML001005 (NOLOCK) P ON I.OS = P.OS AND I.IDCRIACAO = P.IDCRIACAO
		WHERE P.ID IS NULL AND I.OS = @NUM_OS AND I.IDPRD <> '' AND K.TIPOAGRUPADOR=0 AND I.IDCRIACAO=ISNULL(@IDCRIACAO,I.IDCRIACAO);


	COMMIT

	/**************************************************************************************************************************************************************
		
		DELETA AS INFORMAÇÕES DE COMPONENTES DAS ESTRUTURAS EXCLUSIVAS

	***************************************************************************************************************************************************************/

	BEGIN TRAN 		

		DELETE K
		FROM FLUIG.dbo.Z_CRM_EX001005 (NOLOCK) I
				INNER JOIN KATVESTRUTURA K ON K.CODCOLIGADA = 1 AND K.CODFILIAL = I.CODFILIAL AND K.CODESTRUTURA = I.CODIGOPRD COLLATE SQL_Latin1_General_CP1_CI_AI
				LEFT JOIN FLUIG.dbo.Z_CRM_ML001005 (NOLOCK) P ON I.OS = P.OS AND I.IDCRIACAO = P.IDCRIACAO
		WHERE P.ID IS NULL AND I.OS = @NUM_OS AND I.IDPRD <> '' AND I.IDCRIACAO=ISNULL(@IDCRIACAO,I.IDCRIACAO);

	COMMIT

	/**************************************************************************************************************************************************************
		
		DELETA AS INFORMAÇÕES DE ATIVIDADES DAS ESTRUTURAS EXCLUSIVAS PARA SEREM RECRIADAS

	***************************************************************************************************************************************************************/

	BEGIN TRAN 

		INSERT INTO KATVESTRUTURA
			SELECT DISTINCT I.CODCOLIGADA,  I.CODIGOPRD, C.CODATIVIDADE, 1 HORAS, MIN( CAST(C.PRIORIDADE AS INT) ) ,
			SUM(	CAST( CASE WHEN C.FILA = '' THEN NULL ELSE REPLACE(C.FILA,',','.') END AS FLOAT) ), 
			SUM(	CAST( CASE WHEN C.CONFIGURACAO = '' THEN NULL ELSE REPLACE(C.CONFIGURACAO,',','.') END AS FLOAT) ), 
			SUM(	CAST( CASE WHEN C.PROCESSAMENTO = '' THEN NULL ELSE REPLACE(C.PROCESSAMENTO,',','.') END AS FLOAT)), 
			SUM(	CAST( CASE WHEN C.DESAGREGACAO = '' THEN NULL ELSE REPLACE(C.DESAGREGACAO,',','.') END AS FLOAT)), 
			SUM(	CAST( CASE WHEN C.ESPERA = '' THEN NULL ELSE REPLACE(C.ESPERA,',','.') END AS FLOAT)), 
			SUM(	CAST( CASE WHEN C.MOVIMENTACAO = '' THEN NULL ELSE REPLACE(C.MOVIMENTACAO,',','.') END AS FLOAT)),
				1,0,'P',0,NULL,I.CODFILIAL, 'fluig', GETDATE(),'fluig', GETDATE() 
			FROM FLUIG.dbo.Z_CRM_EX001005 (NOLOCK) I 
				INNER JOIN FLUIG.dbo.Z_CRM_EX001021 (NOLOCK) C ON I.OS = C.OSPROCESSO AND C.IDCRIACAOPROCESSO = I.IDCRIACAO  AND C.EXECUCAO = I.EXECUCAO
				INNER JOIN KESTRUTURA KE ON I.CODCOLIGADA = KE.CODCOLIGADA AND I.CODIGOPRD COLLATE SQL_Latin1_General_CP1_CI_AI = KE.CODESTRUTURA AND KE.CODFILIAL = I.CODFILIAL
				LEFT JOIN KATVESTRUTURA K ON K.CODCOLIGADA = 1 AND K.CODFILIAL = I.CODFILIAL AND K.CODATIVIDADE = C.CODATIVIDADE COLLATE SQL_Latin1_General_CP1_CI_AI  AND K.CODESTRUTURA = I.CODIGOPRD COLLATE SQL_Latin1_General_CP1_CI_AI
				LEFT JOIN FLUIG.dbo.Z_CRM_ML001005 (NOLOCK) P ON I.OS = P.OS AND I.IDCRIACAO = P.IDCRIACAO
			WHERE  P.ID IS NULL AND  K.CODATIVIDADE IS NULL
			AND		 @NUM_OS = I.OS AND @EXECUCAO = I.EXECUCAO AND @CODTRFPAI = I.CODTRFPAI AND I.TIPODESENHO NOT IN ('NAOMANUFATURADO','INDUSTRIALIZACAO') AND I.IDCRIACAO=ISNULL(@IDCRIACAO,I.IDCRIACAO) 
			GROUP BY  I.CODCOLIGADA, I.CODIGOPRD, C.CODATIVIDADE,I.CODFILIAL;
	COMMIT
	
	/**************************************************************************************************************************************************************
		
		INSERE AS INFORMAÇÕES DE ATIVIDADES DAS ESTRUTURAS EXCLUSIVAS CASO ELAS NÃO EXISTAM

	***************************************************************************************************************************************************************/

	BEGIN TRAN 

		INSERT INTO  KETPATIVIDADES 
			SELECT DISTINCT I.CODCOLIGADA,'ETP-GLOBAL',C.CODATIVIDADE,I.CODFILIAL, 'fluig', GETDATE(),'fluig', GETDATE() 
			FROM FLUIG.dbo.Z_CRM_EX001005 (NOLOCK) I
				INNER JOIN FLUIG.dbo.Z_CRM_EX001021 (NOLOCK) C ON I.OS = C.OSPROCESSO AND C.IDCRIACAOPROCESSO = I.IDCRIACAO  AND C.EXECUCAO = I.EXECUCAO
				LEFT JOIN KETPATIVIDADES K ON K.CODCOLIGADA = I.CODCOLIGADA AND K.CODFILIAL = I.CODFILIAL AND K.CODATIVIDADE = C.CODATIVIDADE COLLATE SQL_Latin1_General_CP1_CI_AI
				LEFT JOIN FLUIG.dbo.Z_CRM_ML001005 (NOLOCK) P ON I.OS = P.OS AND I.IDCRIACAO = P.IDCRIACAO
			WHERE  P.ID IS NULL AND  K.CODATIVIDADE IS NULL
			AND		 @NUM_OS = I.OS AND @EXECUCAO = I.EXECUCAO AND @CODTRFPAI = I.CODTRFPAI AND I.TIPODESENHO NOT IN ('NAOMANUFATURADO','INDUSTRIALIZACAO') AND I.IDCRIACAO=ISNULL(@IDCRIACAO,I.IDCRIACAO) 
			GROUP BY  I.CODCOLIGADA, I.CODIGOPRD, C.CODATIVIDADE, I.CODFILIAL

	COMMIT

	/**************************************************************************************************************************************************************
		
		INSERE AS INFORMAÇÕES DE ETAPAS DAS ATIVIDADES DAS ESTRUTURAS EXCLUSIVAS CASO ELAS NÃO EXISTAM

	***************************************************************************************************************************************************************/

	BEGIN TRAN 
			
			INSERT INTO KATVESTRUTURACOMPL (CODCOLIGADA, CODESTRUTURA, CODATIVIDADE,CODFILIAL, DETALHE, RECCREATEDBY, RECCREATEDON, RECMODIFIEDBY, RECMODIFIEDON)
			SELECT DISTINCT I.CODCOLIGADA,  I.CODIGOPRD, C.CODATIVIDADE, I.CODFILIAL, C.DESCPROCESSO , 'fluig', GETDATE(),'fluig', GETDATE() 
			FROM FLUIG.dbo.Z_CRM_EX001005 (NOLOCK) I 
				INNER JOIN FLUIG.dbo.Z_CRM_EX001021 (NOLOCK) C ON I.OS = C.OSPROCESSO AND C.IDCRIACAOPROCESSO = I.IDCRIACAO  AND I.EXECUCAO = C.EXECUCAO
				INNER JOIN KATVESTRUTURA KA ON KA.CODCOLIGADA = 1 AND KA.CODFILIAL = I.CODFILIAL AND KA.CODATIVIDADE = C.CODATIVIDADE COLLATE SQL_Latin1_General_CP1_CI_AI  AND KA.CODESTRUTURA = I.CODIGOPRD COLLATE SQL_Latin1_General_CP1_CI_AI
				LEFT JOIN KATVESTRUTURACOMPL K ON K.CODCOLIGADA = I.CODCOLIGADA AND K.CODFILIAL = I.CODFILIAL  AND K.CODESTRUTURA = I.CODIGOPRD COLLATE SQL_Latin1_General_CP1_CI_AI AND C.CODATIVIDADE COLLATE SQL_Latin1_General_CP1_CI_AI = K.CODATIVIDADE
				LEFT JOIN FLUIG.dbo.Z_CRM_ML001005 (NOLOCK) P ON I.OS = P.OS AND I.IDCRIACAO = P.IDCRIACAO
			WHERE  P.ID IS NULL AND K.CODESTRUTURA IS NULL AND @NUM_OS = I.OS AND @EXECUCAO = I.EXECUCAO AND @CODTRFPAI = I.CODTRFPAI AND I.IDCRIACAO=ISNULL(@IDCRIACAO,I.IDCRIACAO) ;

	COMMIT

	/**************************************************************************************************************************************************************
		
		INSERE AS INFORMAÇÕES COMPLEMENTARES DAS ATIVIDADES DAS ESTRUTURAS EXCLUSIVAS CASO ELAS NÃO EXISTAM

	***************************************************************************************************************************************************************/

	BEGIN TRAN 
			
			INSERT INTO KATVESTPOSTO (CODCOLIGADA, CODPOSTO, CODATIVIDADE, CODESTRUTURA, CODFILIAL, RECCREATEDBY, RECCREATEDON, RECMODIFIEDBY, RECMODIFIEDON)
			SELECT DISTINCT K.CODCOLIGADA, K.CODPOSTO, C.CODATIVIDADE, I.CODIGOPRD, K.CODFILIAL, 'fluig', GETDATE(),'fluig', GETDATE() 
			FROM FLUIG.dbo.Z_CRM_EX001005 (NOLOCK) I 
				LEFT JOIN FLUIG.dbo.Z_CRM_ML001005 (NOLOCK) PN ON I.OS = PN.OS AND I.IDCRIACAO = PN.IDCRIACAO
				INNER JOIN FLUIG.dbo.Z_CRM_EX001021 (NOLOCK) C ON I.OS = C.OSPROCESSO AND C.IDCRIACAOPROCESSO = I.IDCRIACAO AND C.EXECUCAO = I.EXECUCAO
				INNER JOIN KATVESTRUTURA KA ON KA.CODCOLIGADA = 1 AND KA.CODFILIAL = I.CODFILIAL AND KA.CODATIVIDADE = C.CODATIVIDADE COLLATE SQL_Latin1_General_CP1_CI_AI  AND KA.CODESTRUTURA = I.CODIGOPRD COLLATE SQL_Latin1_General_CP1_CI_AI
				INNER JOIN KPOSTO (NOLOCK) K ON K.CODCOLIGADA = 1 AND K.CODFILIAL = I.CODFILIAL AND K.CODPOSTO = C.CODPOSTO COLLATE SQL_Latin1_General_CP1_CI_AI
				LEFT JOIN KATVESTPOSTO P ON P.CODCOLIGADA = K.CODCOLIGADA AND P.CODFILIAL = K.CODFILIAL AND P.CODESTRUTURA = I.CODIGOPRD COLLATE SQL_Latin1_General_CP1_CI_AI AND P.CODPOSTO = K.CODPOSTO
			WHERE  PN.ID IS NULL AND P.CODCOLIGADA IS NULL AND  @NUM_OS = I.OS AND @EXECUCAO = I.EXECUCAO AND @CODTRFPAI = I.CODTRFPAI AND I.IDCRIACAO=ISNULL(@IDCRIACAO,I.IDCRIACAO)  ;
		
	COMMIT

	/**************************************************************************************************************************************************************
		
		INSERE AS INFORMAÇÕES DE POSTO DAS ATIVIDADES DAS ESTRUTURAS EXCLUSIVAS CASO ELAS NÃO EXISTAM

	***************************************************************************************************************************************************************/


	BEGIN TRAN 

			INSERT INTO KCOMPONENTE (CODCOLIGADA, CODESTRUTURA, IDPRODUTO, IDAUTOINC, QTDUSADA, CODATIVIDADE, OBRIGASERMATERIAPRIMA, FAZPARTEMODELOBASE, PERMITEEXCLUSAO, CODFILIAL, RECCREATEDBY, RECCREATEDON, RECMODIFIEDBY, RECMODIFIEDON )

			SELECT  DISTINCT COMPONENTES.CODCOLIGADA, CODIGOPRD, IDPRD, (SELECT MAX(IDAUTOINC) FROM KCOMPONENTE)+ ROW_NUMBER () OVER (ORDER BY IDPRD),COMPONENTES.QTD* 10000,
						ISNULL((SELECT TOP 1 CODATIVIDADE FROM KATVESTRUTURA (NOLOCK) WHERE CODCOLIGADA = COMPONENTES.CODCOLIGADA AND CODESTRUTURA = COMPONENTES.CODIGOPRD COLLATE Latin1_General_CI_AS AND CODFILIAL = COMPONENTES.CODFILIAL AND PRIORIDADE = (CASE WHEN COMPONENTES.PRIORIDADE = 0 THEN PRIORIDADE ELSE COMPONENTES.PRIORIDADE END) ORDER BY PRIORIDADE),
							CASE WHEN LEFT(CODIGOPRD,2) <> '03'
								THEN (SELECT TOP 1 CODATIVIDADE FROM KATVESTRUTURA (NOLOCK) WHERE CODCOLIGADA = COMPONENTES.CODCOLIGADA AND CODESTRUTURA = COMPONENTES.CODIGOPRD COLLATE Latin1_General_CI_AS AND CODFILIAL = COMPONENTES.CODFILIAL ORDER BY PRIORIDADE DESC)
								ELSE (SELECT TOP 1 CODATIVIDADE FROM KATVESTRUTURA (NOLOCK) WHERE CODCOLIGADA = COMPONENTES.CODCOLIGADA AND CODESTRUTURA = COMPONENTES.CODIGOPRD COLLATE Latin1_General_CI_AS AND CODFILIAL = COMPONENTES.CODFILIAL ORDER BY PRIORIDADE ) END
								) ATIVIDADE,
					1, 0, 0, COMPONENTES.CODFILIAL, 'fluig', GETDATE(),'fluig', GETDATE() 
			FROM (
				SELECT  I.CODIGOPRD, E.IDPRD,  CASE WHEN E.UNDMEDIDA='KG' THEN CAST(REPLACE(E.PESOUNITARIO,',','.') AS float) ELSE CAST(E.DESQTDE AS float) END QTD, I.IDCRIACAOPAI, I.IDCRIACAO, NULL PRIORIDADE, E.CODFILIAL, I.CODCOLIGADA,I.EXECUCAO, I.CODTRFPAI
				FROM  FLUIG.dbo.Z_CRM_EX001005 (NOLOCK) I 
					INNER JOIN FLUIG.dbo.Z_CRM_EX001005 (NOLOCK) E ON I.OS = E.OS AND I.IDCRIACAO = E.IDCRIACAOPAI  AND E.EXECUCAO = I.EXECUCAO
					LEFT JOIN FLUIG.dbo.Z_CRM_ML001005 (NOLOCK) P2 ON I.OS = P2.OS AND I.IDCRIACAO = P2.IDCRIACAO
				WHERE P2.CODCOLIGADA IS NULL AND   @NUM_OS = I.OS AND @EXECUCAO = I.EXECUCAO AND @CODTRFPAI = I.CODTRFPAI  AND I.TIPODESENHO NOT IN ('NAOMANUFATURADO','INDUSTRIALIZACAO') AND COALESCE(E.ITEMDERETORNO,0)=0 AND I.IDCRIACAO=ISNULL(@IDCRIACAO,I.IDCRIACAO) 
		
				UNION ALL
		
				SELECT I.CODIGOPRD, C.IDPRDCOMPONENTES IDPRD,  CAST(REPLACE(C.QTDEUNCOMPONENTES,',','.') AS FLOAT) QTD, I.IDCRIACAOPAI, I.IDCRIACAO, C.PRIORIDADEATVCOMPONENTES PRIORIDADE, I.CODFILIAL, I.CODCOLIGADA,I.EXECUCAO, I.CODTRFPAI 
				FROM FLUIG.dbo.Z_CRM_EX001005 (NOLOCK) I 
					INNER JOIN FLUIG.dbo.Z_CRM_EX001019 (NOLOCK) C ON I.OS = C.OSCOMPONENTES AND C.IDCRIACAOCOMPONENTES = I.IDCRIACAO AND C.EXECUCAO = I.EXECUCAO
					LEFT JOIN FLUIG.dbo.Z_CRM_ML001005 (NOLOCK) P2 ON I.OS = P2.OS AND I.IDCRIACAO = P2.IDCRIACAO
				WHERE P2.CODCOLIGADA IS NULL AND   ISNULL(SUBSTITUTOCOMPONENTES,'') = '' AND   @NUM_OS = I.OS AND @EXECUCAO = I.EXECUCAO AND @CODTRFPAI = I.CODTRFPAI AND I.IDCRIACAO=ISNULL(@IDCRIACAO,I.IDCRIACAO) 
			
				UNION ALL

					-- CODIGOS NÃO MANUFATURADO
				SELECT P.CODIGOPRD, C.IDPRDCOMPONENTES IDPRD,  CAST(REPLACE(C.QTDEUNCOMPONENTES,',','.') AS FLOAT)  QTD, I.IDCRIACAOPAI, I.IDCRIACAO, C.PRIORIDADEATVCOMPONENTES PRIORIDADE, I.CODFILIAL, I.CODCOLIGADA,I.EXECUCAO, I.CODTRFPAI
				FROM FLUIG.dbo.Z_CRM_EX001005 (NOLOCK) I 
					INNER JOIN FLUIG.dbo.Z_CRM_EX001019 (NOLOCK) C ON I.OS = C.OSCOMPONENTES AND C.IDCRIACAOCOMPONENTES = I.IDCRIACAO  AND C.EXECUCAO = I.EXECUCAO
					INNER JOIN FLUIG.dbo.Z_CRM_EX001005 (NOLOCK) P ON I.OS = P.OS AND I.IDCRIACAO = P.IDCRIACAOPAI  AND P.EXECUCAO = I.EXECUCAO
					LEFT JOIN FLUIG.dbo.Z_CRM_ML001005 (NOLOCK) P2 ON I.OS = P2.OS AND I.IDCRIACAO = P2.IDCRIACAO
				WHERE P2.CODCOLIGADA IS NULL AND ISNULL(SUBSTITUTOCOMPONENTES,'') = '' AND   @NUM_OS = I.OS AND @EXECUCAO = I.EXECUCAO AND @CODTRFPAI = I.CODTRFPAI AND I.TIPODESENHO = 'NAOMANUFATURADO' AND I.IDCRIACAO=ISNULL(@IDCRIACAO,I.IDCRIACAO) 


			
			) AS COMPONENTES
			INNER JOIN ( SELECT MIN(PRIORIDADE) PRIORIDADE,CODCOLIGADA,CODESTRUTURA,CODFILIAL FROM KATVESTRUTURA (NOLOCK) GROUP BY CODCOLIGADA,CODESTRUTURA,CODFILIAL )
			C ON C.CODCOLIGADA = COMPONENTES.CODCOLIGADA AND C.CODESTRUTURA = COMPONENTES.CODIGOPRD COLLATE Latin1_General_CI_AS AND C.CODFILIAL = COMPONENTES.CODFILIAL
			INNER JOIN KATVESTRUTURA (NOLOCK) C2 ON C2.CODCOLIGADA = C.CODCOLIGADA AND C2.CODESTRUTURA = C.CODESTRUTURA COLLATE Latin1_General_CI_AS AND C2.CODFILIAL = C.CODFILIAL AND C.PRIORIDADE=CASE WHEN COMPONENTES.PRIORIDADE = 0 THEN C2.PRIORIDADE ELSE COMPONENTES.PRIORIDADE END
			LEFT JOIN KCOMPONENTE KC ON KC.CODCOLIGADA=COMPONENTES.CODCOLIGADA AND KC.CODFILIAL=COMPONENTES.CODFILIAL 
			AND KC.CODESTRUTURA=COMPONENTES.CODIGOPRD COLLATE Latin1_General_CI_AS AND KC.IDPRODUTO=COMPONENTES.IDPRD COLLATE Latin1_General_CI_AS
			AND KC.CODATIVIDADE=C2.CODATIVIDADE COLLATE Latin1_General_CI_AS
			WHERE IDPRD != '' AND KC.CODCOLIGADA IS NULL

	COMMIT

	/**************************************************************************************************************************************************************
		
		INSERE AS INFORMAÇÕES DE COMPONENTES DAS ESTRUTURAS EXCLUSIVAS CASO ELAS NÃO EXISTAM

	***************************************************************************************************************************************************************/

	BEGIN TRAN 

		-- INSERE OS PRODUTOS SUBSTITUTOS

		INSERT INTO  KCOMPSUBSTITUTO
		SELECT DISTINCT SUB.CODCOLIGADA, SUB.CODESTRUTURA, SUB.CODATIVIDADE, SUB.IDAUTOINC, SUB.IDPRD, SUB.IDPRDCOMPONENTES, SUB.QTDUSADA*10000, NULL, NULL, 0,  SUB.CODFILIAL, 'fluig', GETDATE(),'fluig', GETDATE()
		FROM (
				SELECT 'A' TIPO, I.IDCRIACAOPAI, I.IDCRIACAO, K.CODCOLIGADA, K.CODESTRUTURA, K.CODATIVIDADE, K.IDAUTOINC, P.IDPRD, C.IDPRDCOMPONENTES, K.QTDUSADA, K.CODFILIAL
					FROM FLUIG.DBO.Z_CRM_EX001005 (NOLOCK) I
					INNER JOIN FLUIG.DBO.Z_CRM_EX001021 (NOLOCK) A ON I.OS = A.OSPROCESSO AND I.IDCRIACAO = A.IDCRIACAOPROCESSO AND I.EXECUCAO = A.EXECUCAO
					INNER JOIN FLUIG.DBO.Z_CRM_EX001019 (NOLOCK) C ON I.OS = C.OSCOMPONENTES AND C.IDCRIACAOCOMPONENTES = I.IDCRIACAO  AND C.EXECUCAO = I.EXECUCAO AND A.PRIORIDADE = C.PRIORIDADEATVCOMPONENTES
					INNER JOIN TPRD(NOLOCK) P ON P.CODCOLIGADA = I.CODCOLIGADA AND P.CODIGOPRD  COLLATE Latin1_General_CI_AS = C.SUBSTITUTOCOMPONENTES
					INNER JOIN KCOMPONENTE (NOLOCK) K ON  P.IDPRD = K.IDPRODUTO 	AND P.CODCOLIGADA = K.CODCOLIGADA AND K.CODESTRUTURA COLLATE Latin1_General_CI_AS = I.CODIGOPRD AND K.CODFILIAL = I.CODFILIAL AND K.CODATIVIDADE COLLATE Latin1_General_CI_AS = A.CODATIVIDADE
					INNER JOIN KESTRUTURA (NOLOCK) E ON K.CODCOLIGADA = E.CODCOLIGADA AND K.CODFILIAL = E.CODFILIAL AND K.CODESTRUTURA = E.CODESTRUTURA AND E.CODCCUSTO COLLATE Latin1_General_CI_AS = I.OS  AND E.RECCREATEDBY = 'fluig'
					LEFT JOIN FLUIG.dbo.Z_CRM_ML001005 (NOLOCK) P2 ON I.OS = P2.OS AND I.IDCRIACAO = P2.IDCRIACAO
				WHERE P2.CODCOLIGADA IS NULL AND  C.PRIORIDADEATVCOMPONENTES <> 0 AND E.STATUSESTR = 1 AND @NUM_OS = I.OS AND @EXECUCAO = I.EXECUCAO AND @CODTRFPAI = I.CODTRFPAI AND ISNULL(C.SUBSTITUTOCOMPONENTES,'') <> '' AND I.IDCRIACAO=ISNULL(@IDCRIACAO,I.IDCRIACAO) 
		
		UNION ALL

				SELECT 'B' TIPO, I.IDCRIACAOPAI, I.IDCRIACAO,  K.CODCOLIGADA, K.CODESTRUTURA, K.CODATIVIDADE, K.IDAUTOINC, P.IDPRD, C.IDPRDCOMPONENTES, K.QTDUSADA, K.CODFILIAL
				FROM FLUIG.DBO.Z_CRM_EX001005 (NOLOCK) I
					INNER JOIN FLUIG.DBO.Z_CRM_EX001021 (NOLOCK) A ON I.OS = A.OSPROCESSO AND I.IDCRIACAO = A.IDCRIACAOPROCESSO AND I.EXECUCAO = A.EXECUCAO
					INNER JOIN FLUIG.DBO.Z_CRM_EX001019 (NOLOCK) C ON I.OS = C.OSCOMPONENTES AND C.IDCRIACAOCOMPONENTES = I.IDCRIACAO  AND C.EXECUCAO = I.EXECUCAO AND A.PRIORIDADE = C.PRIORIDADEATVCOMPONENTES
					INNER JOIN KESTRUTURA (NOLOCK) E ON I.CODCOLIGADA = E.CODCOLIGADA AND I.CODFILIAL = E.CODFILIAL AND I.CODIGOPRD COLLATE SQL_Latin1_General_CP1_CI_AI = E.CODESTRUTURA
					INNER JOIN KCOMPONENTE (NOLOCK) K ON  E.CODCOLIGADA = K.CODCOLIGADA AND  K.CODFILIAL = E.CODFILIAL AND K.CODESTRUTURA = E.CODESTRUTURA
					INNER JOIN TPRD (NOLOCK) P ON K.CODCOLIGADA = P.CODCOLIGADA AND K.IDPRODUTO = P.IDPRD
					LEFT JOIN FLUIG.dbo.Z_CRM_ML001005 (NOLOCK) P2 ON I.OS = P2.OS AND I.IDCRIACAO = P2.IDCRIACAO
			WHERE P2.CODCOLIGADA IS NULL AND  C.PRIORIDADEATVCOMPONENTES = 0 AND E.STATUSESTR = 1 AND @NUM_OS = I.OS AND @EXECUCAO = I.EXECUCAO AND @CODTRFPAI = I.CODTRFPAI AND ISNULL(C.SUBSTITUTOCOMPONENTES,'') <> ''  AND I.IDCRIACAO=ISNULL(@IDCRIACAO,I.IDCRIACAO) 
				
		UNION ALL 

				SELECT 'A' TIPO, I.IDCRIACAOPAI, I.IDCRIACAO, K.CODCOLIGADA, K.CODESTRUTURA, K.CODATIVIDADE, K.IDAUTOINC, P2.IDPRD, C.IDPRDCOMPONENTES, K.QTDUSADA, K.CODFILIAL
				FROM FLUIG.DBO.Z_CRM_EX001005 (NOLOCK) I
					INNER JOIN FLUIG.DBO.Z_CRM_EX001019 (NOLOCK) C ON I.OS = C.OSCOMPONENTES AND C.IDCRIACAOCOMPONENTES = I.IDCRIACAO  AND C.EXECUCAO = I.EXECUCAO 
					INNER JOIN FLUIG.DBO.Z_CRM_EX001005 (NOLOCK) P ON I.OS = P.OS AND I.IDCRIACAOPAI = P.IDCRIACAO AND I.EXECUCAO=P.EXECUCAO
					INNER JOIN FLUIG.DBO.Z_CRM_EX001021 (NOLOCK) A ON P.OS = A.OSPROCESSO AND P.IDCRIACAO = A.IDCRIACAOPROCESSO AND P.EXECUCAO = A.EXECUCAO
					INNER JOIN KESTRUTURA (NOLOCK) E ON P.CODCOLIGADA = E.CODCOLIGADA AND P.CODFILIAL = E.CODFILIAL AND P.CODIGOPRD COLLATE SQL_LATIN1_GENERAL_CP1_CI_AI = E.CODESTRUTURA
					INNER JOIN KCOMPONENTE (NOLOCK) K ON  E.CODCOLIGADA = K.CODCOLIGADA AND  K.CODFILIAL = E.CODFILIAL AND K.CODESTRUTURA = E.CODESTRUTURA
					INNER JOIN TPRD (NOLOCK) P2 ON K.CODCOLIGADA = P2.CODCOLIGADA AND K.IDPRODUTO = P2.IDPRD  AND P2.CODIGOPRD=C.SUBSTITUTOCOMPONENTES COLLATE  SQL_LATIN1_GENERAL_CP1_CI_AI
					LEFT JOIN FLUIG.dbo.Z_CRM_ML001005 (NOLOCK) PRI ON I.OS = PRI.OS AND I.IDCRIACAO = PRI.IDCRIACAO
				WHERE PRI.IDCRIACAO IS NULL AND @NUM_OS = I.OS AND @EXECUCAO = I.EXECUCAO AND @CODTRFPAI = I.CODTRFPAI AND I.TIPODESENHO = 'NAOMANUFATURADO' AND ISNULL(C.SUBSTITUTOCOMPONENTES,'') <> '' AND E.STATUSESTR = 1 AND I.IDCRIACAO=ISNULL(@IDCRIACAO,I.IDCRIACAO) 

			) SUB
		LEFT JOIN KCOMPSUBSTITUTO S ON S.CODCOLIGADA = SUB.CODCOLIGADA AND S.CODFILIAL = SUB.CODFILIAL AND S.CODESTRUTURA = SUB.CODESTRUTURA AND S.CODATIVIDADE = SUB.CODATIVIDADE AND S.IDAUTOINC = SUB.IDAUTOINC AND S.IDPRDORIGEM = SUB.IDPRD AND S.IDPRD = SUB.IDPRDCOMPONENTES
		WHERE S.CODCOLIGADA IS NULL
		ORDER BY SUB.CODESTRUTURA, SUB.CODATIVIDADE, SUB.IDPRD, SUB.IDPRDCOMPONENTES;

	COMMIT

	/**************************************************************************************************************************************************************
		
		INSERE AS INFORMAÇÕES DE COMPONENTES SUBSTITUTOS DAS ESTRUTURAS EXCLUSIVAS CASO ELAS NÃO EXISTAM

	***************************************************************************************************************************************************************/

	BEGIN TRAN

		UPDATE GAUTOINC SET VALAUTOINC = (SELECT MAX(CAST(LEFT(CODORDEM, CHARINDEX('/',CODORDEM)-1) AS int)) FROM KORDEM (NOLOCK) WHERE CODCOLIGADA = @CODCOLIGADA AND CODFILIAL = @CODFILIAL) WHERE CODCOLIGADA = @CODCOLIGADA AND CODAUTOINC = 'KORDEM-'+CAST(@CODFILIAL AS VARCHAR(2))
	
	COMMIT

	BEGIN TRAN 
	
		INSERT INTO KORDEM (CODCOLIGADA, CODCCUSTO,  CODORDEM, DSCORDEM, RESPONSAVEL, DTHRINICIALPREV, STATUS, DTHRFINALPREV, CODFILIAL, RECCREATEDBY, RECCREATEDON, RECMODIFIEDBY, RECMODIFIEDON) 
		SELECT DISTINCT I.CODCOLIGADA, I.OS, CAST( ROW_NUMBER() OVER (ORDER BY I.IDCRIACAO) + (SELECT VALAUTOINC FROM GAUTOINC WHERE CODAUTOINC = 'KORDEM-'+CAST(I.CODFILIAL AS VARCHAR(2))) AS varchar(MAX))+'/'+RIGHT(CAST(YEAR(GETDATE()) AS varchar(MAX)),2),
					LEFT(P.DESCRICAO,80), CONCAT(P.CODIGOPRD,';',CAST(@NUMPROCESSO AS VARCHAR(MAX)),'-',CAST(I.EXECUCAO AS varchar(10)) COLLATE SQL_Latin1_General_CP1_CI_AI,'/',I.CODTRFPAI COLLATE SQL_Latin1_General_CP1_CI_AI) , GETDATE(), 0, GETDATE(), I.CODFILIAL, 'fluig', GETDATE(),'fluig', GETDATE() 
		FROM FLUIG.dbo.Z_CRM_EX001005 (NOLOCK) I 
				INNER JOIN TPRD (NOLOCK) P ON P.CODCOLIGADA = I.CODCOLIGADA  AND I.IDPRD = P.IDPRD
				INNER JOIN KESTRUTURA (NOLOCK) K ON K.CODCOLIGADA = I.CODCOLIGADA AND K.CODFILIAL = I.CODFILIAL AND K.IDPRODUTO = P.IDPRD AND K.CODESTRUTURA = P.CODIGOPRD				
				LEFT JOIN FLUIG.dbo.Z_CRM_EX001005COMPL (NOLOCK) CL ON CL.CODCOLIGADA=I.CODCOLIGADA AND CL.CODFILIAL=I.CODFILIAL AND CL.OS=I.OS AND CL.IDCRIACAO=I.IDCRIACAO AND CL.EXECUCAO=I.EXECUCAO
				LEFT JOIN KORDEM (NOLOCK) KK ON KK.CODCOLIGADA=K.CODCOLIGADA AND KK.CODFILIAL=K.CODFILIAL AND KK.RESPONSAVEL LIKE CONCAT(P.CODIGOPRD,';','%','-',CAST(I.EXECUCAO AS varchar(10)) COLLATE SQL_Latin1_General_CP1_CI_AI,'/',I.CODTRFPAI COLLATE SQL_Latin1_General_CP1_CI_AI)
		WHERE ISNULL(I.OPSUNITARIAS,'') <> 'SIM' AND CL.CODORDEM IS NULL AND KK.CODORDEM IS NULL AND @NUM_OS = I.OS COLLATE SQL_Latin1_General_CP1_CI_AI AND @EXECUCAO = I.EXECUCAO AND @CODTRFPAI = I.CODTRFPAI  COLLATE SQL_Latin1_General_CP1_CI_AI AND  I.TIPODESENHO NOT IN ('NAOMANUFATURADO','INDUSTRIALIZACAO') AND I.IDCRIACAO=ISNULL(@IDCRIACAO,I.IDCRIACAO) 

		UPDATE GAUTOINC SET VALAUTOINC = (SELECT MAX(CAST(LEFT(CODORDEM, CHARINDEX('/',CODORDEM)-1) AS int)) FROM KORDEM  (NOLOCK) WHERE CODCOLIGADA = @CODCOLIGADA AND CODFILIAL = @CODFILIAL) WHERE CODCOLIGADA = @CODCOLIGADA AND CODAUTOINC = 'KORDEM-'+CAST(@CODFILIAL AS VARCHAR(2))
	
	COMMIT

	/**************************************************************************************************************************************************************
		
		INSERE A ORDEM DE PRODUÇÃO CASO AINDA NÃO EXISTA, EXCETO DOS ITENS NÃO MANUFATURADOS E INDUSTRIALIZADOS

	***************************************************************************************************************************************************************/

	BEGIN TRAN

			INSERT INTO KMODELO
			SELECT DISTINCT I.CODCOLIGADA,  I.CODIGOPRD, 'Base','Modelo Base',I.CODFILIAL, 'fluig', GETDATE(),'fluig', GETDATE() 
			FROM   FLUIG.dbo.Z_CRM_EX001005 (NOLOCK) I 
					INNER JOIN KESTRUTURA(NOLOCK) E ON E.CODCOLIGADA = I.CODCOLIGADA AND E.CODESTRUTURA = I.CODIGOPRD  COLLATE SQL_Latin1_General_CP1_CI_AI
					LEFT JOIN KMODELO K ON K.CODCOLIGADA = I.CODCOLIGADA AND K.CODFILIAL = I.CODFILIAL AND K.CODESTRUTURA = E.CODESTRUTURA
			WHERE ISNULL(I.OPSUNITARIAS,'') <> 'SIM' AND K.CODESTRUTURA IS NULL
			AND	@NUM_OS = I.OS AND @EXECUCAO = I.EXECUCAO AND @CODTRFPAI = I.CODTRFPAI AND I.TIPODESENHO NOT IN ('NAOMANUFATURADO','INDUSTRIALIZACAO') 

	COMMIT

	/**************************************************************************************************************************************************************
		
		INSERE O MODELO DA ORDEM DE PRODUÇÃO CASO AINDA NÃO EXISTA

	***************************************************************************************************************************************************************/	

	PRINT 'INÍCIO'
	
	BEGIN TRAN 	

			INSERT INTO KITEMORDEM(CODCOLIGADA, CODORDEM, CODESTRUTURA, CODMODELO, CODLINHA, STATUS, QTDEPLANEJADA, DTHRINICIALPREV, DTHRFINALPREV, IDITEMORDEM, TIPOAPONTAMENTO, CODFILIAL, CODCCUSTO,  RECCREATEDBY, RECCREATEDON, RECMODIFIEDBY, RECMODIFIEDON)
			SELECT DISTINCT I.CODCOLIGADA, KO.CODORDEM,
					K.CODESTRUTURA, 'Base', '001', 0,CASE WHEN I.UNDMEDIDA='KG' THEN CAST(REPLACE(I.PESOBRUTO,',','.') AS float) ELSE CAST(I.TOTALQTDE AS float) END, GETDATE(), GETDATE(), ROW_NUMBER() OVER (ORDER BY K.CODESTRUTURA)+(SELECT MAX(IDITEMORDEM) FROM KITEMORDEM), 1, I.CODFILIAL, I.OS, 'fluig', GETDATE(),'fluig', GETDATE() 
			FROM  FLUIG.dbo.Z_CRM_EX001005 (NOLOCK) I
					INNER JOIN KESTRUTURA (NOLOCK) K ON K.CODCOLIGADA = I.CODCOLIGADA AND K.CODFILIAL = I.CODFILIAL AND K.CODESTRUTURA = I.CODIGOPRD COLLATE SQL_Latin1_General_CP1_CI_AI
					INNER JOIN KORDEM (NOLOCK) KO ON KO.CODCOLIGADA = I.CODCOLIGADA AND KO.CODFILIAL = I.CODFILIAL AND KO.CODCCUSTO=I.OS COLLATE SQL_Latin1_General_CP1_CI_AI 
					AND KO.RESPONSAVEL LIKE CONCAT(K.CODESTRUTURA,';%-',CAST(@EXECUCAO AS varchar(10)),'/',@CODTRFPAI) 
					INNER JOIN KMODELO (NOLOCK) M ON I.CODCOLIGADA=M.CODCOLIGADA AND I.CODFILIAL=M.CODFILIAL AND K.CODESTRUTURA=M.CODESTRUTURA AND M.CODMODELO='Base'
					LEFT JOIN KITEMORDEM OI ON K.CODCOLIGADA = OI.CODCOLIGADA AND K.CODFILIAL = OI.CODFILIAL AND K.CODESTRUTURA = OI.CODESTRUTURA AND OI.CODORDEM = KO.CODORDEM
			WHERE ISNULL(I.OPSUNITARIAS,'') <> 'SIM' AND KO.STATUS!=6 AND OI.CODORDEM IS NULL AND @NUM_OS = I.OS AND @EXECUCAO = I.EXECUCAO AND @CODTRFPAI = I.CODTRFPAI AND I.TIPODESENHO NOT IN ('NAOMANUFATURADO','INDUSTRIALIZACAO') AND I.IDCRIACAO=ISNULL(@IDCRIACAO,I.IDCRIACAO) 

	COMMIT

	PRINT 'FIM'

	/**************************************************************************************************************************************************************
		
		INSERE O ITEM DA ORDEM DE PRODUÇÃO CASO AINDA NÃO EXISTA

	***************************************************************************************************************************************************************/


	BEGIN TRAN 

		INSERT INTO KORDEMCOMPL (CODCOLIGADA, CODORDEM, CODFILIAL, NUMEXEC, RECCREATEDBY, RECCREATEDON, RECMODIFIEDBY, RECMODIFIEDON)
			SELECT DISTINCT I.CODCOLIGADA, KO.CODORDEM, KO.CODFILIAL, I.EXECUCAO, 'fluig', GETDATE(),'fluig', GETDATE() 
			FROM FLUIG.dbo.Z_CRM_EX001005 (NOLOCK) I 
				INNER JOIN KESTRUTURA (NOLOCK) K ON K.CODCOLIGADA = I.CODCOLIGADA AND K.CODFILIAL = I.CODFILIAL AND K.CODESTRUTURA = I.CODIGOPRD COLLATE SQL_Latin1_General_CP1_CI_AI
				INNER JOIN KITEMORDEM (NOLOCK) O ON I.CODCOLIGADA = O.CODCOLIGADA AND I.CODFILIAL = O.CODFILIAL AND O.CODESTRUTURA=K.CODESTRUTURA 
				INNER JOIN KORDEM (NOLOCK) KO ON KO.CODCOLIGADA = O.CODCOLIGADA AND KO.CODFILIAL = O.CODFILIAL AND KO.CODORDEM=O.CODORDEM 
				LEFT JOIN KORDEMCOMPL OI ON K.CODCOLIGADA = OI.CODCOLIGADA AND K.CODFILIAL = OI.CODFILIAL AND OI.CODORDEM = KO.CODORDEM
			WHERE  OI.CODORDEM IS NULL AND KO.STATUS!=6 AND ISNULL(I.OPSUNITARIAS,'') <> 'SIM' AND @NUM_OS = I.OS AND @EXECUCAO = I.EXECUCAO AND @CODTRFPAI = I.CODTRFPAI AND I.TIPODESENHO NOT IN ('NAOMANUFATURADO','INDUSTRIALIZACAO') 
			AND I.IDCRIACAO=ISNULL(@IDCRIACAO,I.IDCRIACAO) 

	COMMIT

	/**************************************************************************************************************************************************************
		
		INSERE AS INFORMAÇÕES COMPLEMENTARES DAS ORDENS CASO AINDA NÃO EXISTAM

	***************************************************************************************************************************************************************/


	BEGIN TRAN 

		UPDATE  O SET QTDEPLANEJADA = CASE WHEN I.UNDMEDIDA='KG' THEN CAST(REPLACE(I.PESOBRUTO,',','.') AS float) ELSE CAST(I.TOTALQTDE AS float) END, RECCREATEDBY='fluig',RECCREATEDON= GETDATE(),RECMODIFIEDBY='fluig', RECMODIFIEDON=GETDATE() 
		FROM  FLUIG.dbo.Z_CRM_EX001005 (NOLOCK) I 
			INNER JOIN KESTRUTURA (NOLOCK) K ON K.CODCOLIGADA = I.CODCOLIGADA AND K.CODFILIAL = I.CODFILIAL AND K.CODESTRUTURA = I.CODIGOPRD COLLATE SQL_Latin1_General_CP1_CI_AI
			INNER JOIN KITEMORDEM (NOLOCK) O ON I.CODCOLIGADA = O.CODCOLIGADA AND I.CODFILIAL = O.CODFILIAL AND O.CODESTRUTURA=K.CODESTRUTURA 
			INNER JOIN KORDEM (NOLOCK) KO ON KO.CODCOLIGADA = O.CODCOLIGADA AND KO.CODFILIAL = O.CODFILIAL AND KO.CODORDEM=O.CODORDEM 
			INNER JOIN KORDEMCOMPL (NOLOCK) KL ON KL.CODCOLIGADA = O.CODCOLIGADA AND KL.CODFILIAL = O.CODFILIAL AND KL.CODORDEM=O.CODORDEM AND KL.NUMEXEC=I.EXECUCAO
		WHERE ISNULL(I.OPSUNITARIAS,'') <> 'SIM' AND O.STATUS NOT IN (5,6) AND  @NUM_OS = I.OS AND @EXECUCAO = I.EXECUCAO AND @CODTRFPAI = I.CODTRFPAI AND I.TIPODESENHO NOT IN ('NAOMANUFATURADO','INDUSTRIALIZACAO') AND I.IDCRIACAO=ISNULL(@IDCRIACAO,I.IDCRIACAO) ;

	COMMIT

	/**************************************************************************************************************************************************************
		
		ATUALIZA OS ITEM DAS ORDENS JÁ CADASTRADAS EXECETO AS ORDENS CONCLUÍDAS OU CANCELADAS OU ORDENS UNITÁRIAS

	***************************************************************************************************************************************************************/

	BEGIN TRAN

		UPDATE GAUTOINC SET VALAUTOINC = (SELECT MAX(CAST(LEFT(CODORDEM, CHARINDEX('/',CODORDEM)-1) AS int)) FROM KORDEM WHERE CODCOLIGADA = @CODCOLIGADA AND CODFILIAL = @CODFILIAL) WHERE CODCOLIGADA = @CODCOLIGADA AND CODAUTOINC = 'KORDEM-'+CAST(@CODFILIAL AS VARCHAR(2))
	
	COMMIT

	DECLARE @CODESTRUTURA VARCHAR(MAX), @QTDDESENHO INT

	DECLARE INDIVIDUAL CURSOR FOR 	

		SELECT DISTINCT K.CODESTRUTURA,  CAST(I.TOTALQTDE AS float)
		FROM FLUIG.dbo.Z_CRM_EX001005 (NOLOCK) I
			INNER JOIN KESTRUTURA (NOLOCK) K ON K.CODCOLIGADA = I.CODCOLIGADA AND K.CODFILIAL = I.CODFILIAL AND K.CODESTRUTURA = I.CODIGOPRD COLLATE SQL_Latin1_General_CP1_CI_AI
			LEFT JOIN  FLUIG.dbo.Z_CRM_EX001005COMPL CL ON CL.CODCOLIGADA=I.CODCOLIGADA AND CL.CODFILIAL=I.CODFILIAL AND CL.OS=I.OS AND CL.IDCRIACAO=I.IDCRIACAO AND CL.EXECUCAO=I.EXECUCAO
		WHERE ISNULL(I.OPSUNITARIAS,'') = 'SIM' AND CL.CODORDEM IS NULL AND @NUM_OS = I.OS AND @EXECUCAO = I.EXECUCAO AND @CODTRFPAI = I.CODTRFPAI AND I.TIPODESENHO NOT IN ('NAOMANUFATURADO','INDUSTRIALIZACAO')
		AND I.IDCRIACAO=ISNULL(@IDCRIACAO,I.IDCRIACAO) 
		ORDER BY K.CODESTRUTURA;

		/**************************************************************************************************************************************************************
		
			INICIA CURSOR PARA CRIAÇÃO DAS ORDENS DE PRODUÇÃO UNITÁRIAS

		***************************************************************************************************************************************************************/
			
	OPEN INDIVIDUAL;

	FETCH NEXT FROM INDIVIDUAL INTO @CODESTRUTURA, @QTDDESENHO;

	WHILE @@FETCH_STATUS = 0 
	BEGIN

		/**************************************************************************************************************************************************************
		
			INICIA LOOP QUE INICIA EM 1 E TERMINA QUANDO ATINGE A QUANTIDADE DA ORDEM DE PRODUÇÃO UNITÁRIA, OU SEJA, CASO A ORDEM TENHA QUANTIDADE 4 E SEJA UNITÁRIA,
			SERÃO CRIADAS 4 ORDENS DE PRODUÇÃO COM QUANTIDADE 1

		***************************************************************************************************************************************************************/	
		DECLARE @INDIVIDUAL INT = 1;
		WHILE @INDIVIDUAL <= @QTDDESENHO
		BEGIN
							
			BEGIN TRAN 

				INSERT INTO KORDEM (CODCOLIGADA, CODCCUSTO,  CODORDEM, DSCORDEM, RESPONSAVEL, DTHRINICIALPREV, STATUS, DTHRFINALPREV, CODFILIAL, RECCREATEDBY, RECCREATEDON, RECMODIFIEDBY, RECMODIFIEDON)
				SELECT DISTINCT I.CODCOLIGADA, I.OS, CAST( ROW_NUMBER() OVER (ORDER BY I.IDCRIACAO) + (SELECT VALAUTOINC FROM GAUTOINC WHERE CODAUTOINC = 'KORDEM-'+CAST(I.CODFILIAL AS VARCHAR(2))) AS varchar(MAX))+'/'+RIGHT(CAST(YEAR(GETDATE()) AS varchar(MAX)),2),
							LEFT(P.DESCRICAO,80), CONCAT(P.CODIGOPRD,';',CAST(@NUMPROCESSO AS VARCHAR(MAX)),'-',CAST(@EXECUCAO AS varchar(10)),'/',@CODTRFPAI,'|',CAST(@INDIVIDUAL AS VARCHAR(MAX))), GETDATE(), 0, GETDATE(), I.CODFILIAL,'fluig', GETDATE(),'fluig',GETDATE()
				FROM  FLUIG.dbo.Z_CRM_EX001005 (NOLOCK) I 
						INNER JOIN TPRD (NOLOCK) P ON P.CODCOLIGADA = i.CODCOLIGADA  AND I.IDPRD = P.IDPRD
						INNER JOIN KESTRUTURA (NOLOCK) K ON K.CODCOLIGADA = I.CODCOLIGADA AND K.CODFILIAL = I.CODFILIAL AND K.IDPRODUTO = P.IDPRD					
						LEFT JOIN  FLUIG.dbo.Z_CRM_EX001005COMPL (NOLOCK) CL ON CL.CODCOLIGADA=I.CODCOLIGADA AND CL.CODFILIAL=I.CODFILIAL AND CL.OS=I.OS AND CL.IDCRIACAO=I.IDCRIACAO AND CL.EXECUCAO=I.EXECUCAO
						LEFT JOIN KORDEM (NOLOCK) KK ON KK.CODCOLIGADA=K.CODCOLIGADA AND KK.CODFILIAL=K.CODFILIAL AND KK.RESPONSAVEL LIKE CONCAT(P.CODIGOPRD,';','%','-',CAST(@EXECUCAO AS varchar(10)),'/',@CODTRFPAI,'|',CAST(@INDIVIDUAL AS VARCHAR(MAX)))
				WHERE CL.CODORDEM IS NULL AND KK.CODORDEM IS NULL AND K.CODESTRUTURA = @CODESTRUTURA AND ISNULL(I.OPSUNITARIAS,'') = 'SIM' AND @NUM_OS = I.OS AND @EXECUCAO = I.EXECUCAO AND @CODTRFPAI = I.CODTRFPAI  AND I.TIPODESENHO NOT IN ('NAOMANUFATURADO','INDUSTRIALIZACAO') AND I.IDCRIACAO=ISNULL(@IDCRIACAO,I.IDCRIACAO) 

				UPDATE GAUTOINC SET VALAUTOINC = (SELECT MAX(CAST(LEFT(CODORDEM, CHARINDEX('/',CODORDEM)-1) AS int)) FROM KORDEM WHERE CODCOLIGADA = @CODCOLIGADA AND CODFILIAL = @CODFILIAL) WHERE CODCOLIGADA = @CODCOLIGADA AND CODAUTOINC = 'KORDEM-'+CAST(@CODFILIAL AS VARCHAR(2))

			COMMIT

			/**************************************************************************************************************************************************************
		
				INSERE A ORDEM DE PRODUÇÃO UNITÁRIA CASO AINDA NÃO EXISTA

			***************************************************************************************************************************************************************/	

			BEGIN TRAN 

				INSERT INTO KMODELO
				SELECT DISTINCT I.CODCOLIGADA,  I.CODIGOPRD, 'Base','Modelo Base',I.CODFILIAL, 'fluig', GETDATE(),'fluig',GETDATE() 
				FROM FLUIG.dbo.Z_CRM_EX001005 (NOLOCK) I 
					INNER JOIN KESTRUTURA(NOLOCK) E ON E.CODCOLIGADA = I.CODCOLIGADA AND E.CODESTRUTURA = I.CODIGOPRD  COLLATE SQL_Latin1_General_CP1_CI_AI
					LEFT JOIN KMODELO K ON K.CODCOLIGADA = I.CODCOLIGADA AND K.CODFILIAL = I.CODFILIAL AND K.CODESTRUTURA = I.CODIGOPRD  COLLATE SQL_Latin1_General_CP1_CI_AI
				WHERE I.CODIGOPRD = @CODESTRUTURA AND ISNULL(I.OPSUNITARIAS,'') = 'SIM' AND  @NUM_OS = I.OS AND @EXECUCAO = I.EXECUCAO AND @CODTRFPAI = I.CODTRFPAI AND K.CODESTRUTURA IS NULL
				AND	I.TIPODESENHO NOT IN ('NAOMANUFATURADO','INDUSTRIALIZACAO')

			COMMIT

			/**************************************************************************************************************************************************************
		
				INSERE O MODELO DA ORDEM DE PRODUÇÃO UNITÁRIA CASO AINDA NÃO EXISTA

			***************************************************************************************************************************************************************/	

			BEGIN TRAN 
			
				INSERT INTO KITEMORDEM(CODCOLIGADA, CODORDEM, CODESTRUTURA, CODMODELO, CODLINHA, STATUS, QTDEPLANEJADA, DTHRINICIALPREV, DTHRFINALPREV, IDITEMORDEM, TIPOAPONTAMENTO, CODFILIAL, CODCCUSTO,  RECCREATEDBY, RECCREATEDON, RECMODIFIEDBY, RECMODIFIEDON)
				SELECT DISTINCT I.CODCOLIGADA, O.CODORDEM,
						K.CODESTRUTURA, 'Base', '001', 0, CASE WHEN I.UNDMEDIDA='KG' THEN CAST(REPLACE(I.PESOUNITARIO,',','.') AS float) ELSE CAST(1 AS float) END QTDE_INDIVIDUAL, GETDATE(), GETDATE(), ROW_NUMBER() OVER (ORDER BY K.CODESTRUTURA)+(SELECT MAX(IDITEMORDEM) FROM KITEMORDEM), 1, I.CODFILIAL, I.OS, 'fluig', GETDATE(),'fluig', GETDATE()
				FROM FLUIG.dbo.Z_CRM_EX001005 (NOLOCK) I 
					INNER JOIN KESTRUTURA (NOLOCK) K ON K.CODCOLIGADA = I.CODCOLIGADA AND K.CODFILIAL = I.CODFILIAL AND K.CODESTRUTURA = I.CODIGOPRD COLLATE SQL_Latin1_General_CP1_CI_AI
					INNER JOIN KORDEM (NOLOCK) O ON  O.CODCOLIGADA = I.CODCOLIGADA AND O.CODFILIAL = I.CODFILIAL AND O.RESPONSAVEL LIKE CONCAT(I.CODIGOPRD COLLATE SQL_Latin1_General_CP1_CI_AI,';%-',CAST(@EXECUCAO AS varchar(10)),'/',@CODTRFPAI,'|',CAST(@INDIVIDUAL AS VARCHAR(MAX)))
					INNER JOIN KMODELO (NOLOCK) M ON I.CODCOLIGADA=M.CODCOLIGADA AND I.CODFILIAL=M.CODFILIAL AND K.CODESTRUTURA=M.CODESTRUTURA AND M.CODMODELO='Base'
					LEFT JOIN KITEMORDEM OI ON K.CODCOLIGADA = OI.CODCOLIGADA AND K.CODFILIAL = OI.CODFILIAL AND K.CODESTRUTURA = OI.CODESTRUTURA COLLATE SQL_Latin1_General_CP1_CI_AI AND OI.CODORDEM = O.CODORDEM COLLATE SQL_Latin1_General_CP1_CI_AI
				WHERE K.CODESTRUTURA = @CODESTRUTURA AND ISNULL(I.OPSUNITARIAS,'') = 'SIM' AND O.STATUS!=6 AND @NUM_OS = I.OS AND @EXECUCAO = I.EXECUCAO AND @CODTRFPAI = I.CODTRFPAI AND OI.CODORDEM IS NULL AND I.TIPODESENHO NOT IN ('NAOMANUFATURADO','INDUSTRIALIZACAO') AND I.IDCRIACAO=ISNULL(@IDCRIACAO,I.IDCRIACAO) 

			COMMIT

			/**************************************************************************************************************************************************************
		
				INSERE O ITEM DA ORDEM DE PRODUÇÃO UNITÁRIA CASO AINDA NÃO EXISTA

			***************************************************************************************************************************************************************/

			BEGIN TRAN 

				INSERT INTO KORDEMCOMPL (CODCOLIGADA, CODORDEM, CODFILIAL, NUMEXEC, RECCREATEDBY, RECCREATEDON, RECMODIFIEDBY, RECMODIFIEDON)
				SELECT DISTINCT I.CODCOLIGADA, O.CODORDEM, O.CODFILIAL, @EXECUCAO, 'fluig', GETDATE(),'fluig',GETDATE()
				FROM  FLUIG.dbo.Z_CRM_EX001005 (NOLOCK) I 
					INNER JOIN KESTRUTURA (NOLOCK) K ON K.CODCOLIGADA = I.CODCOLIGADA AND K.CODFILIAL = I.CODFILIAL AND K.CODESTRUTURA = I.CODIGOPRD COLLATE SQL_Latin1_General_CP1_CI_AI
					INNER JOIN KITEMORDEM (NOLOCK) O ON I.CODCOLIGADA = O.CODCOLIGADA AND I.CODFILIAL = O.CODFILIAL AND O.CODESTRUTURA=K.CODESTRUTURA 
					INNER JOIN KORDEM (NOLOCK) KO ON KO.CODCOLIGADA = O.CODCOLIGADA AND KO.CODFILIAL = O.CODFILIAL AND KO.CODORDEM=O.CODORDEM 
					LEFT JOIN KORDEMCOMPL OI ON K.CODCOLIGADA = OI.CODCOLIGADA AND K.CODFILIAL = OI.CODFILIAL AND OI.CODORDEM = O.CODORDEM
				WHERE K.CODESTRUTURA = @CODESTRUTURA AND ISNULL(I.OPSUNITARIAS,'') = 'SIM' AND O.STATUS!=6 AND @NUM_OS = I.OS AND @EXECUCAO = I.EXECUCAO AND @CODTRFPAI = I.CODTRFPAI AND OI.CODORDEM IS NULL  AND I.TIPODESENHO NOT IN ('NAOMANUFATURADO','INDUSTRIALIZACAO') AND I.IDCRIACAO=ISNULL(@IDCRIACAO,I.IDCRIACAO) 

			COMMIT

			/**************************************************************************************************************************************************************
		
				INSERE AS INFORMAÇÕES COMPLEMENTARES DA ORDEM DE PRODUÇÃO UNITÁRIA CASO AINDA NÃO EXISTA

			***************************************************************************************************************************************************************/
			 
			
			SET @INDIVIDUAL += 1;
		END;
				
		FETCH NEXT FROM INDIVIDUAL INTO @CODESTRUTURA, @QTDDESENHO;
	END
	CLOSE INDIVIDUAL;
	DEALLOCATE INDIVIDUAL;

	BEGIN TRAN 

		INSERT INTO  KATVORDEM (CODCOLIGADA, CODORDEM, CODESTRUTURA, CODMODELO, CODATIVIDADE, CODETAPA, CODESTRUTURAFEITA, CODPOSTO, DTHRINICIOPREV, DTHRFINALPREV, QTESTOQUE, QTPREVISTA, QUANTIDADE,PERCENTUAL, STATUS, IDATVORDEM, IDATVDEPEND, TEMPO, DTHORAIDEAL, TIPODELAY, CODMODELOFEITO, CODFILIAL, RECCREATEDBY, RECCREATEDON, RECMODIFIEDBY, RECMODIFIEDON)
		SELECT DISTINCT I.CODCOLIGADA, I.CODORDEM, I.CODESTRUTURA, I.CODMODELO, C.CODATIVIDADE, 'ETP-GLOBAL' , I.CODESTRUTURA, C.CODPOSTO, I.DTHRINICIALPREV, I.DTHRFINALPREV, 0, 
		 CASE WHEN  ISNULL(I5.OPSUNITARIAS,'') = 'SIM' THEN CAST(1 AS float) ELSE CAST(I5.TOTALQTDE AS float) END 
		, 0, 0, 0,ROW_NUMBER() OVER ( PARTITION BY I.CODCOLIGADA, I.CODORDEM ORDER BY I.CODCOLIGADA, I.CODORDEM, C.PRIORIDADE)+ISNULL((SELECT MAX(IDATVORDEM) FROM KATVORDEM ATV WHERE ATV.CODCOLIGADA = I.CODCOLIGADA AND ATV.CODFILIAL = I.CODFILIAL AND ATV.CODORDEM = I.CODORDEM),0), -1, (I.QTDEPLANEJADA * CASE WHEN C.MINUTOSGASTOS='' OR C.MINUTOSGASTOS IS NULL THEN 3 ELSE C.MINUTOSGASTOS END),I.DTHRFINALPREV, -1, I.CODMODELO, I.CODFILIAL, 'fluig',getdate(),'fluig',getdate() 
		FROM  FLUIG.dbo.Z_CRM_EX001005 (NOLOCK) I5 
			INNER JOIN FLUIG.dbo.Z_CRM_EX001021 (NOLOCK) C ON I5.OS = C.OSPROCESSO AND C.IDCRIACAOPROCESSO = I5.IDCRIACAO  AND C.EXECUCAO = I5.EXECUCAO
			INNER JOIN KITEMORDEM (NOLOCK) I ON I5.CODCOLIGADA = I.CODCOLIGADA AND I5.CODFILIAL = I.CODFILIAL AND I5.CODIGOPRD=I.CODESTRUTURA COLLATE SQL_Latin1_General_CP1_CI_AI
			INNER JOIN KORDEM (NOLOCK) KO ON KO.CODCOLIGADA = I.CODCOLIGADA AND KO.CODFILIAL = I.CODFILIAL AND KO.CODORDEM=I.CODORDEM 
			INNER JOIN KORDEMCOMPL (NOLOCK) KL ON KL.CODCOLIGADA = I.CODCOLIGADA AND KL.CODFILIAL = I.CODFILIAL AND KL.CODORDEM=I.CODORDEM AND KL.NUMEXEC=I5.EXECUCAO
			LEFT JOIN KATVORDEM AO ON AO.CODCOLIGADA = I.CODCOLIGADA AND AO.CODFILIAL = I.CODFILIAL AND AO.CODORDEM = I.CODORDEM AND AO.CODATIVIDADE = C.CODATIVIDADE COLLATE SQL_Latin1_General_CP1_CI_AI 
			AND AO.CODESTRUTURA=I.CODESTRUTURA AND AO.CODMODELO=I.CODMODELO
		WHERE ISNULL(KO.REPROCESSAMENTO,0) <> 1 AND AO.CODATIVIDADE IS NULL AND @NUM_OS = I5.OS AND I.STATUS NOT IN (5,6) AND @EXECUCAO = I5.EXECUCAO AND @CODTRFPAI = I5.CODTRFPAI AND I5.IDCRIACAO=ISNULL(@IDCRIACAO,I5.IDCRIACAO) 

	COMMIT

	/**************************************************************************************************************************************************************
		
		INSERE AS ATIVIDADES DAS ORDENS DE PRODUÇÃO QUE NÃO ESTÃO CONCLUÍDAS NEM CANCELADAS E AINDA NÃO EXISTEM

	***************************************************************************************************************************************************************/

	BEGIN TRAN 

		UPDATE C SET PRIORIDADE=I21.PRIORIDADE
			FROM  FLUIG.dbo.Z_CRM_EX001005 (NOLOCK) I 
			INNER JOIN FLUIG.dbo.Z_CRM_EX001021 (NOLOCK) I21 ON I.OS = I21.OSPROCESSO AND I21.IDCRIACAOPROCESSO = I.IDCRIACAO  AND I21.EXECUCAO = I.EXECUCAO
			INNER JOIN KITEMORDEM (NOLOCK) O ON I.CODCOLIGADA = O.CODCOLIGADA AND I.CODFILIAL = O.CODFILIAL AND I.CODIGOPRD=O.CODESTRUTURA COLLATE SQL_Latin1_General_CP1_CI_AI
			INNER JOIN KORDEMCOMPL (NOLOCK) KL ON KL.CODCOLIGADA = O.CODCOLIGADA AND KL.CODFILIAL = O.CODFILIAL AND KL.CODORDEM=O.CODORDEM AND KL.NUMEXEC=I.EXECUCAO
			INNER JOIN KORDEM (NOLOCK) KO ON KO.CODCOLIGADA = O.CODCOLIGADA AND KO.CODFILIAL = O.CODFILIAL AND KO.CODORDEM=O.CODORDEM 
			INNER JOIN KATVORDEM (NOLOCK) K ON O.CODCOLIGADA = K.CODCOLIGADA AND O.CODORDEM = K.CODORDEM AND O.CODFILIAL = K.CODFILIAL AND K.CODATIVIDADE=I21.CODATIVIDADE COLLATE SQL_Latin1_General_CP1_CI_AI
			INNER JOIN KATVORDEMCOMPL C ON C.CODCOLIGADA = K.CODCOLIGADA AND C.CODORDEM = K.CODORDEM AND C.CODFILIAL = K.CODFILIAL AND C.IDATVORDEM = K.IDATVORDEM
			LEFT JOIN FLUIG.DBO.Z_DELP_NECESSIDADEPAPC (NOLOCK) PA ON PA.CODCOLIGADA=K.CODCOLIGADA AND PA.CODFILIAL=K.CODFILIAL AND PA.CODORDEM=K.CODORDEM AND PA.CODATIVIDADE=K.CODATIVIDADE
		WHERE ISNULL(KO.REPROCESSAMENTO,0) <> 1 AND K.STATUS = 0 AND O.STATUS NOT IN (5,6) AND  @NUM_OS = I.OS AND @EXECUCAO = I.EXECUCAO AND @CODTRFPAI = I.CODTRFPAI AND PA.CODORDEM IS NULL AND I.IDCRIACAO=ISNULL(@IDCRIACAO,I.IDCRIACAO) 

	COMMIT

	/**************************************************************************************************************************************************************
		
		ATUALIZA A INFORMAÇÃO DE PRIORIDADE DAS ATIVIDADES DAS ORDENS DE PRODUÇÃO QUE NÃO ESTÃO CONCLUÍDAS NEM CANCELADAS E AS ATIVIDADES ESTÃO PLANEJADAS

	***************************************************************************************************************************************************************/

	BEGIN TRAN 

		UPDATE AO SET CODATIVIDADE=C.CODATIVIDADE
		FROM  FLUIG.dbo.Z_CRM_EX001005 (NOLOCK) I5 
			INNER JOIN FLUIG.dbo.Z_CRM_EX001021 (NOLOCK) C ON I5.OS = C.OSPROCESSO AND C.IDCRIACAOPROCESSO = I5.IDCRIACAO  AND C.EXECUCAO = I5.EXECUCAO
			INNER JOIN KITEMORDEM (NOLOCK) I ON I5.CODCOLIGADA = I.CODCOLIGADA AND I5.CODFILIAL = I.CODFILIAL AND I5.CODIGOPRD=I.CODESTRUTURA COLLATE SQL_Latin1_General_CP1_CI_AI
			INNER JOIN KORDEM (NOLOCK) KO ON KO.CODCOLIGADA = I.CODCOLIGADA AND KO.CODFILIAL = I.CODFILIAL AND KO.CODORDEM=I.CODORDEM 
			INNER JOIN KORDEMCOMPL (NOLOCK) KL ON KL.CODCOLIGADA = I.CODCOLIGADA AND KL.CODFILIAL = I.CODFILIAL AND KL.CODORDEM=I.CODORDEM AND KL.NUMEXEC=I5.EXECUCAO
			INNER JOIN KATVORDEM AO ON AO.CODCOLIGADA = I.CODCOLIGADA AND AO.CODFILIAL = I.CODFILIAL AND AO.CODORDEM = I.CODORDEM AND AO.CODATIVIDADE = C.CODATIVIDADE COLLATE SQL_Latin1_General_CP1_CI_AI 
			AND AO.CODESTRUTURA=I.CODESTRUTURA AND AO.CODMODELO=I.CODMODELO
			LEFT JOIN FLUIG.DBO.Z_DELP_NECESSIDADEPAPC (NOLOCK) PA ON PA.CODCOLIGADA=AO.CODCOLIGADA AND PA.CODFILIAL=AO.CODFILIAL AND PA.CODORDEM=AO.CODORDEM AND PA.CODATIVIDADE=AO.CODATIVIDADE
		WHERE ISNULL(KO.REPROCESSAMENTO,0) <> 1 AND @NUM_OS = I5.OS AND I.STATUS NOT IN (5,6) AND AO.STATUS=0 AND @EXECUCAO = I5.EXECUCAO AND @CODTRFPAI = I5.CODTRFPAI AND PA.CODORDEM IS NULL AND I5.IDCRIACAO=ISNULL(@IDCRIACAO,I5.IDCRIACAO) 

	COMMIT

	/**************************************************************************************************************************************************************
		
		ATUALIZA INFORMAÇÕES ( CODIGO DA ATIVIDADE, CODIGO DO POSTO, TEMPO PREVISTO, QUANTIDADE PREVISTA ) DAS ATIVIDADES DAS ORDENS DE PRODUÇÃO QUE NÃO ESTÃO CONCLUÍDAS NEM CANCELADAS E AS ATIVIDADES ESTÃO PLANEJADAS

	***************************************************************************************************************************************************************/

	BEGIN TRAN 

		UPDATE AO SET CODPOSTO=C.CODPOSTO,QTPREVISTA=(CASE WHEN  ISNULL(I5.OPSUNITARIAS,'') = 'SIM' THEN CAST(1 AS float) ELSE CAST(I5.TOTALQTDE AS float) END),TEMPO = ((CASE WHEN  ISNULL(I5.OPSUNITARIAS,'') = 'SIM' THEN CAST(1 AS float) ELSE CAST(I5.TOTALQTDE AS float) END) * CASE WHEN C.MINUTOSGASTOS='' OR C.MINUTOSGASTOS IS NULL THEN 3 ELSE C.MINUTOSGASTOS END) 
		FROM  FLUIG.dbo.Z_CRM_EX001005 (NOLOCK) I5 
			INNER JOIN FLUIG.dbo.Z_CRM_EX001021 (NOLOCK) C ON I5.OS = C.OSPROCESSO AND C.IDCRIACAOPROCESSO = I5.IDCRIACAO  AND C.EXECUCAO = I5.EXECUCAO
			INNER JOIN KITEMORDEM (NOLOCK) I ON I5.CODCOLIGADA = I.CODCOLIGADA AND I5.CODFILIAL = I.CODFILIAL AND I5.CODIGOPRD=I.CODESTRUTURA COLLATE SQL_Latin1_General_CP1_CI_AI
			INNER JOIN KORDEM (NOLOCK) KO ON KO.CODCOLIGADA = I.CODCOLIGADA AND KO.CODFILIAL = I.CODFILIAL AND KO.CODORDEM=I.CODORDEM 
			INNER JOIN KORDEMCOMPL (NOLOCK) KL ON KL.CODCOLIGADA = I.CODCOLIGADA AND KL.CODFILIAL = I.CODFILIAL AND KL.CODORDEM=I.CODORDEM AND KL.NUMEXEC=I5.EXECUCAO
			INNER JOIN KATVORDEM AO ON AO.CODCOLIGADA = I.CODCOLIGADA AND AO.CODFILIAL = I.CODFILIAL AND AO.CODORDEM = I.CODORDEM AND AO.CODATIVIDADE = C.CODATIVIDADE COLLATE SQL_Latin1_General_CP1_CI_AI 
			AND AO.CODESTRUTURA=I.CODESTRUTURA AND AO.CODMODELO=I.CODMODELO
		WHERE ISNULL(KO.REPROCESSAMENTO,0) <> 1 AND @NUM_OS = I5.OS AND I.STATUS NOT IN (5,6) AND AO.STATUS NOT IN (6) AND @EXECUCAO = I5.EXECUCAO AND @CODTRFPAI = I5.CODTRFPAI AND I5.IDCRIACAO=ISNULL(@IDCRIACAO,I5.IDCRIACAO) 

	COMMIT

	/**************************************************************************************************************************************************************
		
		ATUALIZA INFORMAÇÕES ( CODIGO DO POSTO, TEMPO PREVISTO, QUANTIDADE PREVISTA ) DAS ATIVIDADES DAS ORDENS DE PRODUÇÃO QUE NÃO ESTÃO CONCLUÍDAS NEM CANCELADAS E AS ATIVIDADES QUE NÃO ESTÃO CONCLUÍDAS NEM CANCELADAS

	***************************************************************************************************************************************************************/

	BEGIN TRAN

		UPDATE GAUTOINC SET VALAUTOINC  = (SELECT MAX(IDATVORDEMMATERIAPRIMA) FROM KATVORDEMMP)
		WHERE CODAUTOINC = 'IDATVORDEMMATERIAPRIMA' 
		AND CODSISTEMA = 'K' 
		AND CODCOLIGADA = 0;

	COMMIT

	BEGIN TRAN 

		DELETE MP
		FROM   FLUIG.dbo.Z_CRM_EX001005 (NOLOCK) I
			INNER JOIN KITEMORDEM (NOLOCK) O ON I.CODCOLIGADA = O.CODCOLIGADA AND I.CODFILIAL = O.CODFILIAL AND I.CODIGOPRD=O.CODESTRUTURA COLLATE SQL_Latin1_General_CP1_CI_AI
			INNER JOIN KORDEMCOMPL (NOLOCK) KL ON KL.CODCOLIGADA = O.CODCOLIGADA AND KL.CODFILIAL = O.CODFILIAL AND KL.CODORDEM=O.CODORDEM AND KL.NUMEXEC=I.EXECUCAO
			INNER JOIN KORDEM (NOLOCK) KO ON KO.CODCOLIGADA = O.CODCOLIGADA AND KO.CODFILIAL = O.CODFILIAL AND KO.CODORDEM=O.CODORDEM 
			INNER JOIN KATVORDEMMP MP ON MP.CODCOLIGADA = O.CODCOLIGADA AND MP.CODFILIAL = O.CODFILIAL AND MP.CODORDEM = O.CODORDEM 
			INNER JOIN KATVORDEM (NOLOCK) A ON A.CODCOLIGADA = O.CODCOLIGADA AND A.CODFILIAL = O.CODFILIAL AND A.CODORDEM = O.CODORDEM AND A.IDATVORDEM=MP.IDATIVIDADE
			LEFT JOIN KATVORDEMMPLOTE MP3 ON MP3.CODCOLIGADA=MP.CODCOLIGADA AND MP3.CODFILIAL=MP.CODFILIAL AND MP3.IDATVORDEMMATERIAPRIMA=MP.IDATVORDEMMATERIAPRIMA
		WHERE ISNULL(KO.REPROCESSAMENTO,0) <> 1 AND MP.EFETIVADO = 0 AND O.STATUS NOT IN (5,6) AND  @NUM_OS = I.OS AND @EXECUCAO = I.EXECUCAO AND @CODTRFPAI = I.CODTRFPAI AND MP3.QUANTIDADE IS NULL AND I.IDCRIACAO=ISNULL(@IDCRIACAO,I.IDCRIACAO) 

	COMMIT

	/**************************************************************************************************************************************************************
		
		DELETA OS COMPONENTES PREVISTOS DAS ORDEM DE PRODUÇÃO QUE NÃO ESTÃO CONCLUÍDAS NEM CANCELADAS PARA RECRIAR

	***************************************************************************************************************************************************************/

	DECLARE KATVORDEMMP CURSOR FOR

		/**************************************************************************************************************************************************************
		
			DECLARA CURSOR PARA INSERIR OS COMPONENTES DAS ORDENS DE PRODUÇÃO QUE NÃO ESTÃO CONCLUÍDAS NEM CANCELADAS

		***************************************************************************************************************************************************************/

			SELECT DISTINCT
		A.CODCOLIGADA, A.CODORDEM, A.CODESTRUTURA, A.CODMODELO, A.IDATVORDEM, A.DTHRINICIOPREV DTAPONTAMENTO, C.IDPRD, NULL NSEQITMGRD, ISNULL(C.QTD,0) * ISNULL(A.QTPREVISTA,0) QTD,
		0 EFETIVADO, NULL IDLOTE, A.CODFILIAL, ISNULL(C.QTD,0), 0 QTFIXA, 
			ISNULL((SELECT TOP 1 SALDOGERALFISICO FROM TPRD (NOLOCK) WHERE CODCOLIGADA = A.CODCOLIGADA AND  IDPRD = C.IDPRD),0) ESTOQUE, 'fluig',GETDATE(), 'fluig', GETDATE(),
		NULL ESTOQUETERCEIRO, NULL CODCOLCFO, NULL CODCFO, NULL CODFILIALMP, NULL CODLOCAL
		FROM (
				SELECT  CODCOLIGADA, CODIGOPRD, IDPRD, QTD,
											ISNULL((SELECT TOP 1 CODATIVIDADE FROM FLUIG.DBO.Z_CRM_EX001021 E21 WHERE E21.OSPROCESSO = COMPONENTES.OS AND E21.IDCRIACAOPROCESSO = COMPONENTES.IDCRIACAO AND E21.EXECUCAO = COMPONENTES.EXECUCAO AND E21.PRIORIDADE = COMPONENTES.PRIORIDADE),
								CASE WHEN LEFT(CODIGOPRD,2) <> '03'
									THEN (SELECT TOP 1 CODATIVIDADE FROM FLUIG.DBO.Z_CRM_EX001021(NOLOCK) E21 WHERE E21.OSPROCESSO = COMPONENTES.OS AND E21.IDCRIACAOPROCESSO = COMPONENTES.IDCRIACAO AND E21.EXECUCAO = COMPONENTES.EXECUCAO ORDER BY E21.PRIORIDADE DESC)
									ELSE (SELECT TOP 1 CODATIVIDADE FROM FLUIG.DBO.Z_CRM_EX001021(NOLOCK) E21 WHERE E21.OSPROCESSO = COMPONENTES.OS AND E21.IDCRIACAOPROCESSO = COMPONENTES.IDCRIACAO AND E21.EXECUCAO = COMPONENTES.EXECUCAO ORDER BY E21.PRIORIDADE ) END
									) CODATIVIDADE,
						COMPONENTES.CODFILIAL, EXECUCAO, CODTRFPAI, OS
				FROM (
					SELECT  I.CODIGOPRD, E.IDPRD,  CASE WHEN E.UNDMEDIDA='KG' THEN CAST(REPLACE(E.PESOUNITARIO,',','.') AS float) ELSE CAST(E.DESQTDE AS float) END QTD, I.IDCRIACAOPAI, I.IDCRIACAO, NULL PRIORIDADE, E.CODFILIAL, I.CODCOLIGADA,I.EXECUCAO, I.CODTRFPAI, I.OS
					FROM  FLUIG.dbo.Z_CRM_EX001005 (NOLOCK) I
						INNER JOIN FLUIG.dbo.Z_CRM_EX001005 (NOLOCK) E ON I.OS = E.OS AND I.IDCRIACAO = E.IDCRIACAOPAI  AND E.EXECUCAO = I.EXECUCAO
					WHERE  @NUM_OS = I.OS AND @EXECUCAO = I.EXECUCAO AND @CODTRFPAI = I.CODTRFPAI AND I.TIPODESENHO NOT IN ('NAOMANUFATURADO','INDUSTRIALIZACAO') AND COALESCE(E.ITEMDERETORNO,0)=0 
					AND I.IDCRIACAO=ISNULL(@IDCRIACAO,I.IDCRIACAO) 
		
					UNION ALL
		
					SELECT I.CODIGOPRD, C.IDPRDCOMPONENTES IDPRD,  CAST(REPLACE(C.QTDEUNCOMPONENTES,',','.') AS FLOAT) QTD, I.IDCRIACAOPAI, I.IDCRIACAO, C.PRIORIDADEATVCOMPONENTES PRIORIDADE, I.CODFILIAL, I.CODCOLIGADA,I.EXECUCAO, I.CODTRFPAI , I.OS
					FROM  FLUIG.dbo.Z_CRM_EX001005 (NOLOCK) I 
						INNER JOIN FLUIG.dbo.Z_CRM_EX001019 (NOLOCK) C ON I.OS = C.OSCOMPONENTES AND C.IDCRIACAOCOMPONENTES = I.IDCRIACAO AND C.EXECUCAO = I.EXECUCAO
					WHERE  ISNULL(SUBSTITUTOCOMPONENTES,'') = '' AND @NUM_OS = I.OS AND @EXECUCAO = I.EXECUCAO AND @CODTRFPAI = I.CODTRFPAI AND I.IDCRIACAO=ISNULL(@IDCRIACAO,I.IDCRIACAO) 
			
					UNION ALL

						-- CODIGOS NÃO MANUFATURADO
					SELECT P.CODIGOPRD, C.IDPRDCOMPONENTES IDPRD,  CAST(REPLACE(C.QTDEUNCOMPONENTES,',','.') AS FLOAT)  QTD, I.IDCRIACAOPAI, P.IDCRIACAO, C.PRIORIDADEATVCOMPONENTES PRIORIDADE, I.CODFILIAL, I.CODCOLIGADA,I.EXECUCAO, I.CODTRFPAI, I.OS
					FROM  FLUIG.dbo.Z_CRM_EX001005 (NOLOCK) I
						INNER JOIN FLUIG.dbo.Z_CRM_EX001019 (NOLOCK) C ON I.OS = C.OSCOMPONENTES AND C.IDCRIACAOCOMPONENTES = I.IDCRIACAO  AND C.EXECUCAO = I.EXECUCAO
						INNER JOIN FLUIG.dbo.Z_CRM_EX001005 (NOLOCK) P ON I.OS = P.OS AND P.IDCRIACAO = I.IDCRIACAOPAI AND P.EXECUCAO = I.EXECUCAO
					WHERE  ISNULL(SUBSTITUTOCOMPONENTES,'') = '' AND @NUM_OS = I.OS AND @EXECUCAO = I.EXECUCAO AND @CODTRFPAI = I.CODTRFPAI AND I.TIPODESENHO = 'NAOMANUFATURADO'  AND I.IDCRIACAO=ISNULL(@IDCRIACAO,I.IDCRIACAO) 

			
				) AS COMPONENTES
				WHERE IDPRD <> ''
				AND ISNULL((SELECT TOP 1 CODATIVIDADE FROM KATVESTRUTURA (NOLOCK) WHERE CODCOLIGADA = COMPONENTES.CODCOLIGADA AND CODESTRUTURA = COMPONENTES.CODIGOPRD COLLATE Latin1_General_CI_AS AND CODFILIAL = COMPONENTES.CODFILIAL AND PRIORIDADE = CASE WHEN COMPONENTES.PRIORIDADE = 0 THEN PRIORIDADE ELSE COMPONENTES.PRIORIDADE END ORDER BY PRIORIDADE),
								(SELECT TOP 1 CODATIVIDADE FROM KATVESTRUTURA (NOLOCK) WHERE CODCOLIGADA = COMPONENTES.CODCOLIGADA AND CODESTRUTURA = COMPONENTES.CODIGOPRD COLLATE Latin1_General_CI_AS AND CODFILIAL = COMPONENTES.CODFILIAL ORDER BY PRIORIDADE)) IS NOT NULL
				) AS C

				INNER JOIN KITEMORDEM (NOLOCK) I ON C.CODCOLIGADA = I.CODCOLIGADA AND C.CODFILIAL = I.CODFILIAL AND C.CODIGOPRD = I.CODESTRUTURA COLLATE SQL_Latin1_General_CP1_CI_AI
				INNER JOIN KORDEMCOMPL (NOLOCK) O  ON O.CODCOLIGADA=C.CODCOLIGADA AND O.CODFILIAL=C.CODFILIAL AND C.EXECUCAO=O.NUMEXEC AND O.CODORDEM=I.CODORDEM
				INNER JOIN KATVORDEM (NOLOCK) A ON O.CODCOLIGADA = A.CODCOLIGADA AND O.CODFILIAL = A.CODFILIAL AND O.CODORDEM = A.CODORDEM AND C.CODATIVIDADE COLLATE SQL_Latin1_General_CP1_CI_AI = A.CODATIVIDADE
				LEFT JOIN KATVORDEMMP MP ON MP.CODCOLIGADA = O.CODCOLIGADA AND MP.CODFILIAL = O.CODFILIAL AND MP.CODORDEM = O.CODORDEM AND A.IDATVORDEM = MP.IDATIVIDADE AND MP.IDPRODUTO = C.IDPRD AND MP.EFETIVADO = 0
			WHERE MP.CODCOLIGADA IS NULL AND I.STATUS NOT IN (5,6)

	DECLARE @CODCOLIGADA2 INT, @CODORDEM VARCHAR(100), @CODESTRUTURA2 VARCHAR(100), @CODMODELO VARCHAR(100), @IDATVORDEM INT, @DTAPONTAMENTO DATETIME;
	DECLARE @IDPRD INT, @NSEQITMGRD INT, @QTD FLOAT, @EFETIVADO INT, @IDLOTE INT, @CODFILIAL2 INT, @QTD_COLIGADA FLOAT, @QTFIXA INT;
	DECLARE @ESTOQUE FLOAT, @USER_INSERT NVARCHAR(50), @DATA_INSERT DATETIME, @USER_UPDATE NVARCHAR(50), @DATA_UPDATE DATETIME;
	DECLARE @ESTOQUETERCEIRO FLOAT, @CODCOLCFO INT, @CODCFO VARCHAR(100), @CODFILIALMP INT, @CODLOCAL VARCHAR(100);

	OPEN KATVORDEMMP;

	FETCH NEXT FROM KATVORDEMMP INTO  @CODCOLIGADA2, @CODORDEM, @CODESTRUTURA2, @CODMODELO, @IDATVORDEM, @DTAPONTAMENTO,
		@IDPRD, @NSEQITMGRD, @QTD, @EFETIVADO, @IDLOTE, @CODFILIAL2, @QTD_COLIGADA, @QTFIXA, @ESTOQUE, @USER_INSERT, @DATA_INSERT,
		@USER_UPDATE, @DATA_UPDATE, @ESTOQUETERCEIRO, @CODCOLCFO, @CODCFO, @CODFILIALMP, @CODLOCAL;

	WHILE @@FETCH_STATUS = 0
	BEGIN
		
		BEGIN TRAN

			INSERT INTO KATVORDEMMP VALUES ((SELECT MAX(IDATVORDEMMATERIAPRIMA) FROM KATVORDEMMP)+1, @CODCOLIGADA2, @CODORDEM, @CODESTRUTURA2, @CODMODELO, @IDATVORDEM, @DTAPONTAMENTO,
				@IDPRD, @NSEQITMGRD, @QTD, @EFETIVADO, @IDLOTE, @CODFILIAL2, @QTD_COLIGADA, @QTFIXA, @ESTOQUE, @USER_INSERT, @DATA_INSERT,
				@USER_UPDATE, @DATA_UPDATE, @ESTOQUETERCEIRO, @CODCOLCFO, @CODCFO, @CODFILIALMP, @CODLOCAL)

		/**************************************************************************************************************************************************************
		
			INSERE O COMPONENTE NA ORDEM DE PRODUÇÃO

		***************************************************************************************************************************************************************/

		
			UPDATE GAUTOINC SET VALAUTOINC  = (SELECT MAX(IDATVORDEMMATERIAPRIMA) FROM KATVORDEMMP)+1
			WHERE CODAUTOINC = 'IDATVORDEMMATERIAPRIMA' 
			AND CODSISTEMA = 'K' 
			AND CODCOLIGADA = 0;

		COMMIT

		FETCH NEXT FROM KATVORDEMMP INTO @CODCOLIGADA2, @CODORDEM, @CODESTRUTURA2, @CODMODELO, @IDATVORDEM, @DTAPONTAMENTO,
			@IDPRD, @NSEQITMGRD, @QTD, @EFETIVADO, @IDLOTE, @CODFILIAL2, @QTD_COLIGADA, @QTFIXA, @ESTOQUE, @USER_INSERT, @DATA_INSERT,
			@USER_UPDATE, @DATA_UPDATE, @ESTOQUETERCEIRO, @CODCOLCFO, @CODCFO, @CODFILIALMP, @CODLOCAL;
	END

	CLOSE KATVORDEMMP;

	DEALLOCATE KATVORDEMMP;

	BEGIN TRAN

		DELETE MP
		FROM   FLUIG.dbo.Z_CRM_EX001005 (NOLOCK) I
			INNER JOIN KITEMORDEM (NOLOCK) O ON I.CODCOLIGADA = O.CODCOLIGADA AND I.CODFILIAL = O.CODFILIAL AND I.CODIGOPRD=O.CODESTRUTURA COLLATE SQL_Latin1_General_CP1_CI_AI
			INNER JOIN KORDEMCOMPL (NOLOCK) KL ON KL.CODCOLIGADA = O.CODCOLIGADA AND KL.CODFILIAL = O.CODFILIAL AND KL.CODORDEM=O.CODORDEM AND KL.NUMEXEC=I.EXECUCAO
			INNER JOIN KORDEM (NOLOCK) KO ON KO.CODCOLIGADA = O.CODCOLIGADA AND KO.CODFILIAL = O.CODFILIAL AND KO.CODORDEM=O.CODORDEM 
			INNER JOIN KORDEMCOMPSUBSTITUTO MP ON KO.CODCOLIGADA=MP.CODCOLIGADA AND KO.CODFILIAL=MP.CODFILIAL AND KO.CODORDEM=MP.CODORDEM
			WHERE ISNULL(KO.REPROCESSAMENTO,0) <> 1 AND O.STATUS NOT IN (5,6) AND  @NUM_OS = I.OS AND @EXECUCAO = I.EXECUCAO AND @CODTRFPAI = I.CODTRFPAI AND I.IDCRIACAO=ISNULL(@IDCRIACAO,I.IDCRIACAO) 

	COMMIT

	BEGIN TRAN
 
		INSERT INTO KORDEMCOMPSUBSTITUTO
		SELECT R.* FROM (
			SELECT KA.CODCOLIGADA,KA.CODESTRUTURA,KA.CODATIVIDADE,KA.CODORDEM,KA.CODMODELO,(SELECT MAX(IDAUTOINC) FROM KORDEMCOMPSUBSTITUTO)+ROW_NUMBER()OVER(ORDER BY KA.CODCOLIGADA) IDAUTOINC,CAST(RIGHT(C.SUBSTITUTOCOMPONENTES,7) AS INT) IDPRDORIGEM,C.IDPRDCOMPONENTES IDPRD,
			M.QUANTIDADE QTDUSADA,NULL NSEQITMGRD,NULL NSEQITMGRDORIGEM,0 USAGRADE,'fluig' CODUSUARIO,KA.CODESTRUTURA CODESTRUTURAFEITA,KA.CODMODELOFEITO,KA.CODFILIAL,'fluig' RECCREATEDBY,GETDATE() RECCREATEDON,'fluig' RECMODIFIEDBY,GETDATE() RECMODIFIEDON
			FROM 
			FLUIG.DBO.Z_CRM_EX001019 C 
			INNER JOIN FLUIG.DBO.Z_CRM_EX001021 A 
			ON C.OSCOMPONENTES=A.OSPROCESSO
			AND C.IDCRIACAOCOMPONENTES=A.IDCRIACAOPROCESSO
			AND C.EXECUCAO=A.EXECUCAO
			AND (CASE WHEN C.PRIORIDADEATVCOMPONENTES=0 THEN (SELECT MIN(PRIORIDADE) FROM FLUIG.DBO.Z_CRM_EX001021 WHERE OSPROCESSO=A.OSPROCESSO AND EXECUCAO=A.EXECUCAO AND IDCRIACAOPROCESSO=A.IDCRIACAOPROCESSO) ELSE C.PRIORIDADEATVCOMPONENTES END )=A.PRIORIDADE
			INNER JOIN FLUIG.DBO.Z_CRM_EX001005COMPL L ON
			L.OS=C.OSCOMPONENTES
			AND L.IDCRIACAO=C.IDCRIACAOCOMPONENTES
			AND L.EXECUCAO=C.EXECUCAO
			INNER JOIN KATVORDEM KA ON
			KA.CODCOLIGADA=L.CODCOLIGADA
			AND KA.CODFILIAL=L.CODFILIAL
			AND KA.CODORDEM=L.CODORDEM COLLATE SQL_LATIN1_GENERAL_CP1_CI_AI
			AND KA.CODATIVIDADE=A.CODATIVIDADE COLLATE SQL_LATIN1_GENERAL_CP1_CI_AI
			INNER JOIN KATVORDEMMP M ON
			M.CODCOLIGADA=KA.CODCOLIGADA
			AND M.CODFILIAL=KA.CODFILIAL
			AND M.CODESTRUTURA=KA.CODESTRUTURA
			AND M.CODMODELO=KA.CODMODELO
			AND M.CODORDEM=KA.CODORDEM
			AND M.IDATIVIDADE=KA.IDATVORDEM
			AND M.IDPRODUTO=CAST(RIGHT(C.SUBSTITUTOCOMPONENTES,7) AS INT)
			AND M.EFETIVADO=0
			INNER JOIN KORDEM (NOLOCK) KO ON KO.CODCOLIGADA = M.CODCOLIGADA AND KO.CODFILIAL = M.CODFILIAL AND KO.CODORDEM=M.CODORDEM 
			WHERE C.SUBSTITUTOCOMPONENTES!='' AND C.SUBSTITUTOCOMPONENTES!='NULL' AND ISNULL(KO.REPROCESSAMENTO,0) <> 1 AND
			@NUM_OS = L.OS AND @EXECUCAO = L.EXECUCAO AND @CODTRFPAI = L.CODTRFPAI AND L.IDCRIACAO=ISNULL(@IDCRIACAO,L.IDCRIACAO) 
		) R 
		LEFT JOIN KORDEMCOMPSUBSTITUTO K ON
		R.CODCOLIGADA=K.CODCOLIGADA
		AND R.CODFILIAL=K.CODFILIAL
		AND R.CODESTRUTURA=K.CODESTRUTURA
		AND R.CODATIVIDADE=K.CODATIVIDADE
		AND R.CODORDEM=K.CODORDEM	
		AND R.IDPRDORIGEM=K.IDPRDORIGEM
		AND R.IDPRD=K.IDPRD
		WHERE K.CODCOLIGADA IS NULL
 
	COMMIT
 
	/**************************************************************************************************************************************************************
		INSERE AS INFORMAÇÕES DOS COMPONENTES SUBSTITUTOS DA ORDEM DE PRODUÇÃO
 
	***************************************************************************************************************************************************************/
	BEGIN TRAN
 
		INSERT INTO KORDEMCOMPSUBSTITUTO
		SELECT R.* FROM (
			SELECT KA.CODCOLIGADA,KA.CODESTRUTURA,KA.CODATIVIDADE,KA.CODORDEM,KA.CODMODELO,(SELECT MAX(IDAUTOINC) FROM KORDEMCOMPSUBSTITUTO)+ROW_NUMBER()OVER(ORDER BY KA.CODCOLIGADA) IDAUTOINC,CAST(RIGHT(C.SUBSTITUTOCOMPONENTES,7) AS INT) IDPRDORIGEM,C.IDPRDCOMPONENTES IDPRD,
			M.QUANTIDADE QTDUSADA,NULL NSEQITMGRD,NULL NSEQITMGRDORIGEM,0 USAGRADE,'fluig' CODUSUARIO,KA.CODESTRUTURA CODESTRUTURAFEITA,KA.CODMODELOFEITO,KA.CODFILIAL,'fluig' RECCREATEDBY,GETDATE() RECCREATEDON,'fluig' RECMODIFIEDBY,GETDATE() RECMODIFIEDON
			FROM 
			FLUIG.DBO.Z_CRM_EX001019 C 
			INNER JOIN FLUIG.DBO.Z_CRM_EX001005 E
			ON E.OS=C.OSCOMPONENTES
			AND E.EXECUCAO=C.EXECUCAO
			AND E.IDCRIACAO=C.IDCRIACAOCOMPONENTES
			INNER JOIN FLUIG.DBO.Z_CRM_EX001021 A 
			ON C.OSCOMPONENTES=A.OSPROCESSO
			AND E.IDCRIACAOPAI=A.IDCRIACAOPROCESSO
			AND C.EXECUCAO=A.EXECUCAO
			AND (SELECT MIN(PRIORIDADE) FROM FLUIG.DBO.Z_CRM_EX001021 WHERE OSPROCESSO=A.OSPROCESSO AND EXECUCAO=A.EXECUCAO AND IDCRIACAOPROCESSO=A.IDCRIACAOPROCESSO)=A.PRIORIDADE
			INNER JOIN FLUIG.DBO.Z_CRM_EX001005COMPL L ON
			L.OS=C.OSCOMPONENTES
			AND L.IDCRIACAO=E.IDCRIACAOPAI
			AND L.EXECUCAO=C.EXECUCAO
			INNER JOIN KATVORDEM KA ON
			KA.CODCOLIGADA=L.CODCOLIGADA
			AND KA.CODFILIAL=L.CODFILIAL
			AND KA.CODORDEM=L.CODORDEM COLLATE SQL_LATIN1_GENERAL_CP1_CI_AI
			AND KA.CODATIVIDADE=A.CODATIVIDADE COLLATE SQL_LATIN1_GENERAL_CP1_CI_AI
			INNER JOIN KATVORDEMMP M ON
			M.CODCOLIGADA=KA.CODCOLIGADA
			AND M.CODFILIAL=KA.CODFILIAL
			AND M.CODESTRUTURA=KA.CODESTRUTURA
			AND M.CODMODELO=KA.CODMODELO
			AND M.CODORDEM=KA.CODORDEM
			AND M.IDATIVIDADE=KA.IDATVORDEM
			AND M.IDPRODUTO=CAST(RIGHT(C.SUBSTITUTOCOMPONENTES,7) AS INT)
			AND M.EFETIVADO=0
			INNER JOIN KORDEM (NOLOCK) KO ON KO.CODCOLIGADA = M.CODCOLIGADA AND KO.CODFILIAL = M.CODFILIAL AND KO.CODORDEM=M.CODORDEM 
			WHERE C.SUBSTITUTOCOMPONENTES!='' AND C.SUBSTITUTOCOMPONENTES!='NULL' AND E.TIPODESENHO = 'NAOMANUFATURADO' AND ISNULL(KO.REPROCESSAMENTO,0) <> 1 AND
			@NUM_OS = L.OS AND @EXECUCAO = L.EXECUCAO AND @CODTRFPAI = L.CODTRFPAI AND L.IDCRIACAO=ISNULL(@IDCRIACAO,L.IDCRIACAO) 
		) R 
		LEFT JOIN KORDEMCOMPSUBSTITUTO K ON
		R.CODCOLIGADA=K.CODCOLIGADA
		AND R.CODFILIAL=K.CODFILIAL
		AND R.CODESTRUTURA=K.CODESTRUTURA
		AND R.CODATIVIDADE=K.CODATIVIDADE
		AND R.CODORDEM=K.CODORDEM	
		AND R.IDPRDORIGEM=K.IDPRDORIGEM
		AND R.IDPRD=K.IDPRD
		WHERE K.CODCOLIGADA IS NULL
 
	COMMIT
 
	/**************************************************************************************************************************************************************
		INSERE AS INFORMAÇÕES DOS COMPONENTES SUBSTITUTOS DOS ITENS NÃO MANUFATURADOS DA ORDEM DE PRODUÇÃO
 
	***************************************************************************************************************************************************************/

	BEGIN TRAN 

		INSERT INTO KATVORDEMCOMPL (CODCOLIGADA, CODORDEM, CODESTRUTURA, CODMODELO, IDATVORDEM, CODFILIAL, CAUSADOR, NUMERORNC2, RNCRR, RETRABALHO, PRIORIDADE, RECCREATEDBY, RECCREATEDON, RECMODIFIEDBY, RECMODIFIEDON )
		SELECT DISTINCT O.CODCOLIGADA, O.CODORDEM, I.CODESTRUTURA, I.CODMODELO, Z.IDATVORDEM, O.CODFILIAL, NULL CODCLIENTECAUSADOR, NULL NUMRNC,  NULL CODCLIENTERNCRR,  NULL CODCLIENTECAUSA, A.PRIORIDADE, 'fluig',getdate(),'fluig',getdate() 
		FROM KORDEM O (NOLOCK)
			INNER JOIN KITEMORDEM I (NOLOCK) ON O.CODCOLIGADA = I.CODCOLIGADA AND O.CODFILIAL = I.CODFILIAL AND O.CODORDEM = I.CODORDEM
			INNER JOIN FLUIG.DBO.Z_CRM_EX001005 M (NOLOCK) ON I.CODCCUSTO = M.OS COLLATE SQL_Latin1_General_CP1_CI_AI AND I.CODESTRUTURA=M.CODIGOPRD COLLATE SQL_Latin1_General_CP1_CI_AI
			INNER JOIN FLUIG.DBO.Z_CRM_EX001021 A (NOLOCK) ON M.OS = A.OSPROCESSO AND M.IDCRIACAO = A.IDCRIACAOPROCESSO AND M.EXECUCAO = A.EXECUCAO
			INNER JOIN KATVORDEM Z (NOLOCK) ON Z.CODCOLIGADA = O.CODCOLIGADA AND Z.CODFILIAL = O.CODFILIAL AND Z.CODORDEM = O.CODORDEM AND Z.CODATIVIDADE = A.CODATIVIDADE COLLATE SQL_Latin1_General_CP1_CI_AI
			LEFT JOIN KATVORDEMCOMPL L ON L.CODCOLIGADA = Z.CODCOLIGADA AND L.CODFILIAL = Z.CODFILIAL AND L.CODORDEM = Z.CODORDEM AND L.IDATVORDEM = Z.IDATVORDEM
		WHERE  ISNULL(O.REPROCESSAMENTO,0) <> 1 AND L.IDATVORDEM IS NULL AND @NUM_OS = M.OS AND @EXECUCAO = M.EXECUCAO AND @CODTRFPAI = M.CODTRFPAI AND M.IDCRIACAO=ISNULL(@IDCRIACAO,M.IDCRIACAO) 

	COMMIT

	/**************************************************************************************************************************************************************
		
		INSERE AS INFORMAÇÕES COMPLEMENTARES DAS ATIVIDADES DAS ORDENS DE PRODUÇÃO

	***************************************************************************************************************************************************************/

	BEGIN TRAN

		INSERT INTO FLUIG.DBO.Z_CRM_EX001005COMPL
		SELECT DISTINCT Z.CODCOLIGADA,Z.CODFILIAL,Z.OS,Z.CODTRFPAI,K.CODORDEM,Z.EXECUCAO,
		Z.IDCRIACAO,MIN(C.CODCELULA) CODCELULA,(SELECT TOP 1 DESCRICAO FROM GCONSIST WHERE APLICACAO='M' AND CODCLIENTE=FORMAT(ISNULL(MIN(C.CODCELULA),0),'00')),NULL,'fluig',GETDATE(),'fluig',GETDATE() 
		FROM FLUIG.DBO.Z_CRM_EX001005(NOLOCK) Z
		INNER JOIN KITEMORDEM(NOLOCK) K ON
		K.CODCOLIGADA=Z.CODCOLIGADA
		AND K.CODFILIAL=Z.CODFILIAL
		AND K.CODESTRUTURA=Z.CODIGOPRD COLLATE LATIN1_GENERAL_CI_AS
		AND K.CODCCUSTO=Z.OS COLLATE LATIN1_GENERAL_CI_AS
		INNER JOIN KORDEMCOMPL(NOLOCK) KL ON 
		KL.CODCOLIGADA=K.CODCOLIGADA
		AND KL.CODFILIAL=K.CODFILIAL
		AND KL.CODORDEM=K.CODORDEM
		AND KL.NUMEXEC=Z.EXECUCAO
		LEFT JOIN ( SELECT CODCOLIGADA,CODFILIAL,OS,IDCRIACAO,CODCELULA,DESCCELULA FROM FLUIG.DBO.Z_CRM_EX001005COMPL (NOLOCK)
		WHERE CODCELULA IS NOT NULL AND EXECUCAO = (SELECT MIN(EXECUCAO) FROM FLUIG.DBO.Z_CRM_EX001005COMPL ZZ WHERE ZZ.OS=OS AND ZZ.IDCRIACAO=IDCRIACAO)
		GROUP BY CODCOLIGADA,CODFILIAL,OS,IDCRIACAO,CODCELULA,DESCCELULA ) C
		ON C.CODCOLIGADA=Z.CODCOLIGADA
		AND C.CODFILIAL=Z.CODFILIAL
		AND C.OS=Z.OS
		AND C.IDCRIACAO=Z.IDCRIACAO
		LEFT JOIN FLUIG.DBO.Z_CRM_EX001005COMPL CC 
		ON CC.CODCOLIGADA=Z.CODCOLIGADA
		AND CC.CODFILIAL=Z.CODFILIAL
		AND CC.OS=Z.OS
		AND CC.CODORDEM=K.CODORDEM
		WHERE  CC.CODORDEM IS NULL AND Z.ITEMEXCLUSIVO!=2 AND K.CODCCUSTO=@NUM_OS AND Z.IDCRIACAO=ISNULL(@IDCRIACAO,Z.IDCRIACAO) 
		GROUP BY  Z.CODCOLIGADA,Z.CODFILIAL,Z.OS,Z.CODTRFPAI,K.CODORDEM,Z.EXECUCAO,Z.IDCRIACAO

	COMMIT

	/**************************************************************************************************************************************************************
		
		INSERE AS INFORMAÇÕES COMPLEMENTARES DAS EXECUÇÕES NA ESTRUTURA DO FLUIG, INFORMAÇÕES DE CÉLULA ( PREENCHE CASO EXISTA UMA EXECUÇÃO ANTERIOR ) E TAG

	***************************************************************************************************************************************************************/

-- FIM DA RECRIAÇÃO DAS ORDENS

-- FIM DO AJUSTE

END;

